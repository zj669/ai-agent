# 需求文档 - Agent 管理与编排模块 (v2.0)

## 1. 文档概述

### 1.1 简介
Agent 管理模块（Agent Management）旨在为用户提供创建、配置、发布和管理 AI Agent 的全生命周期管理能力。本模块是整个 AI 智能体平台的"控制台"，用户在此通过可视化界面定义 DAG（有向无环图）工作流。

### 1.2 核心价值
- **可视化编排**：通过拖拽节点构建复杂的业务逻辑。
- **版本控制**：支持生产环境与开发环境隔离，支持一键回滚。
- **调试闭环**：提供不发布即可试运行的能力，确保上线质量。

---

## 2. 功能需求详情

### 2.1 基础管理

#### 需求 1：查询 Agent 列表
**用户故事**：作为用户，我希望查看我自己创建的所有 Agent 列表，以便于管理和选择。

**验收标准**：
1.  **WHEN** 用户请求列表 **THEN** 系统应返回当前用户拥有的所有 Agent。
2.  **IF** 用户无数据 **THEN** 返回空列表。
3.  **Sort** 列表应按 `updated_at` 倒序排列（最近修改的在最前）。
4.  **Performance** 返回的列表数据 **严禁** 包含 `graph_json` 大字段，仅返回元数据（ID、名称、图标、描述、状态、更新时间），以保证加载速度。

#### 需求 2：查询 Agent 详情
**用户故事**：作为用户，我希望查看指定 Agent 的详细配置和工作流图，以便于进行编辑。

**验收标准**：
1.  **WHEN** 请求详情 **THEN** 系统返回 Agent 基础信息及完整的 `graph_json`。
2.  **Security** 系统必须校验 `user_id`，如果 Agent 不属于当前用户，返回 403 禁止访问。
3.  **Data** `graph_json` 必须包含完整的 `nodes`（含坐标、配置）和 `edges` 定义。

#### 需求 3：保存 Agent (创建/更新)
**用户故事**：作为用户，我希望保存我的设计工作（草稿），以便于后续继续编辑。

**验收标准**：
1.  **Create** 若 `agentId` 为空，创建新记录，状态默认为 `DRAFT` (草稿)。
2.  **Update** 若 `agentId` 存在，更新对应记录的 `graph_json` 和基础信息。
3.  **Validation** 保存时需校验 JSON 基本格式，并检查节点配置是否符合 `node_template` 定义的必填项约束。
4.  **Concurrency** (可选) 支持乐观锁：更新时检查前端提交的 `updated_at` 是否晚于数据库时间，若数据库较新，提示"有人修改过，请刷新"，防止覆盖。

#### 需求 4：克隆 Agent (新增)
**用户故事**：作为用户，我希望复制一个现有的 Agent，以便于基于现有模版快速开发新应用。

**验收标准**：
1.  **WHEN** 用户点击克隆 **THEN** 系统创建一条新的 Agent 记录。
2.  **Data** 新 Agent 的 `name` 自动追加 "_副本"，`graph_json` 完全复制原 Agent。
3.  **Scope** **不复制** 原 Agent 的历史版本 (`agent_version`) 和 历史对话记录。
4.  **Status** 新 Agent 状态重置为 `DRAFT`。

#### 需求 5：删除 Agent
**用户故事**：作为用户，我希望删除不再需要的 Agent。

**验收标准**：
1.  **Action** 用户请求删除指定 ID。
2.  **Security** 校验所有权。
3.  **Impact** 物理删除 `agent_info` 记录。
4.  **Retention** 关联的历史对话记录 (`workflow_execution`) **不应** 立即物理删除，应保留以供审计或历史查询（可标记为关联 Agent 已失效）。

---

### 2.2 生命周期与版本控制

#### 需求 6：发布 Agent
**用户故事**：作为用户，我希望将设计好的草稿发布到线上，使其对外服务。

**验收标准**：
1.  **Pre-check (DAG 校验)** 发布前系统必须执行严格的图结构校验：
    * **唯一入口**：必须有且仅有一个 `START` 节点。
    * **无环检测**：图中不能存在循环依赖（Cycle）。
    * **连通性**：所有节点必须从 START 节点可达（无孤立节点）。
    * **参数完整**：所有节点的必填配置项必须已填写。
    * *若校验失败，拒绝发布并返回具体错误信息。*
2.  **Action** 校验通过后，将 `agent_info.graph_json` 复制到 `agent_version` 表，生成新版本号。
3.  **State** 更新 Agent 状态为 `PUBLISHED`，并更新 `published_version_id` 指针。

#### 需求 7：查询版本列表 (新增)
**用户故事**：作为用户，我希望查看 Agent 的发布历史，以便了解变更记录。

**验收标准**：
1.  **Query** 查询 `agent_version` 表，条件为当前 `agent_id`。
2.  **Sort** 按 `version` 倒序排列。
3.  **Fields** 返回：版本号、发布时间、版本描述（ChangeLog）。

#### 需求 8：回滚版本
**用户故事**：作为用户，我希望将 Agent 恢复到之前的某个版本，以撤销错误的变更。

**验收标准**：
1.  **Action** 用户选择历史版本 ID 点击回滚。
2.  **Logic** 将该历史版本的 `graph_snapshot` 覆盖回 `agent_info` 的 `graph_json`。
3.  **State** 回滚后状态变为 `DRAFT`（草稿）。
    * *注：回滚仅覆盖草稿区，不直接改变线上服务，用户需确认无误后再次手动点击“发布”才生效。这是为了安全。*

---

### 2.3 调试与运行

#### 需求 9：调试/试运行 (新增)
**用户故事**：作为用户，我希望在不发布的情况下测试当前草稿的逻辑，以确保流程正确。

**验收标准**：
1.  **Trigger** 用户在编辑器中点击“调试”按钮。
2.  **Logic** 后端工作流引擎读取 `agent_info` (草稿) 的配置，而不是 `agent_version` (线上)。
3.  **Flag** 生成的 `workflow_execution` 记录需标记 `debug_mode = 1`。
4.  **Output** 调试模式下，SSE 事件流应包含所有节点的完整 `inputs` 和 `outputs` 数据，无论节点配置的可见性如何。

---

## 3. 非功能需求 (NFR)

### 3.1 性能要求
- **列表加载**：Agent 列表接口响应时间 < 100ms（必须剔除大 JSON 字段）。
- **发布速度**：发布操作（校验+快照）耗时 < 500ms。

### 3.2 数据一致性
- **发布原子性**：`agent_version` 的插入与 `agent_info` 的更新必须在同一个数据库事务中。

### 3.3 安全性
- **水平越权 (IDOR)**：所有涉及 ID 的操作（查、改、删、发布、回滚），必须在 SQL 层强制加上 `AND user_id = current_user_id` 校验。
- **敏感数据**：若 Graph 配置中包含 API Key 等敏感信息，后端在落库前建议加密，或前端只传引用（Secret Reference）。

### 3.4 可扩展性
- **节点类型扩展**：系统应允许通过配置 `node_template` 表动态增加新的节点类型，而无需修改管理模块的核心代码。

---

## 4. 数据校验规则表 (Graph Validation Rules)

| 规则名称 | 说明 | 阻断发布 | 适用场景 |
| :--- | :--- | :--- | :--- |
| **JSON Schema 校验** | 检查 JSON 结构是否符合前端组件规范 | 是 | 保存 & 发布 |
| **必填项校验** | 检查节点配置中 `required=true` 的字段是否有值 | 是 | 发布 |
| **唯一开始节点** | 必须有且仅有一个 `type=START` 的节点 | 是 | 发布 |
| **无环校验** | 图结构必须是 DAG，不能有闭环 | 是 | 发布 |
| **孤立节点检测** | 除 START 外，所有节点必须有入边 | 否 (警告) | 发布 |
| **引用完整性** | Edge 的 source 和 target ID 必须存在于 Nodes 列表中 | 是 | 保存 & 发布 |