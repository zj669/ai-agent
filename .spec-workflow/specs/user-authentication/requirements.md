# 需求文档

## 简介

**用户认证模块（Identity Context）** 是一个通用域模块，负责管理用户身份和 AI-Agent 平台的安全访问。它提供了包括邮箱验证、用户注册、JWT Token 登录以及用户会话管理在内的核心能力。

**核心价值：**
- **安全性**：保护平台免受未经授权的访问。
- **体验**：提供流畅、低摩擦的登录体验。
- **防护**：实施多维度的安全措施（邮箱验证、限流控制）。

## 与产品愿景的一致性

该模块作为整个 AI-Agent 系统的基础 "Identity Context"。通过建立安全可靠的认证机制，它能够：
- **个性化 Agent**：确保用户只能管理和访问属于自己的 Agent。
- **安全的工作流执行**：对执行和管理工作流的请求进行身份验证。
- **架构合规性**：遵守 DDD 战略设计，将身份关注点隔离到单独的限界上下文中。

## 需求

### 需求 1：邮箱验证码

**用户故事：** 作为普通用户，我希望通过电子邮件接收验证码，以便验证我的身份进行注册。

#### 验收标准

1. **当** 用户使用有效邮箱请求验证码时，**则** 系统检查各项限流规则（邮箱：1次/分钟，IP：10次/小时，设备：5次/小时）。
2. **如果** 超过限流阈值，**则** 系统 **应** 返回具体的错误信息，提示已达上限。
3. **当** 检查通过时，**则** 系统 **应** 生成一个 6 位数字验证码，存储并设置 5 分钟有效期，同时触发邮件发送。
4. **当** 邮件服务失败时，**则** 系统 **应** 返回可重试的错误状态。

### 需求 2：用户注册

**用户故事：** 作为新用户，我希望使用邮箱和验证码注册账户，以便访问平台。

#### 验收标准

1. **当** 提交注册信息（邮箱、验证码、密码）时，**则** 系统 **应** 验证验证码是否匹配且未过期。
2. **如果** 邮箱已被注册，**则** 系统 **应** 返回 "用户已存在" 的错误。
3. **当** 验证成功时，**则** 系统 **应** 创建新的 User 聚合根，使用 BCrypt 加密密码，并持久化用户数据。
4. **然后** 系统 **应** 在注册成功后自动生成并返回有效的 JWT Token。

### 需求 3：用户登录

**用户故事：** 作为注册用户，我希望使用邮箱和密码登录，以便获取访问令牌。

#### 验收标准

1. **当** 提交邮箱和密码时，**则** 系统 **应** 验证凭据是否与存储的哈希匹配。
2. **如果** 认证失败，**则** 系统 **应** 返回通用的 "凭据无效" 错误，以防止账号枚举攻击。
3. **当** 认证成功时，**则** 系统 **应** 记录登录 IP 和时间。
4. **然后** 系统 **应** 返回包含用户 ID 的 JWT Token。

### 需求 4：展示用户信息

**用户故事：** 作为已登录用户，我希望查看我的个人资料（如用户名、头像、手机号），以便确认当前登录身份。

#### 验收标准

1. **当** 使用有效的 JWT Token 请求用户信息时，**则** 系统 **应** 返回用户的完整信息：ID、用户名、头像 URL、邮箱、手机号。
2. **如果** Token 无效或过期，**则** 系统 **应** 返回 401 Unauthorized 响应。

### 需求 6：修改用户信息

**用户故事：** 作为已登录用户，我希望修改我的个人资料（用户名、头像、手机号），以便保持信息的准确性。

#### 验收标准

1. **当** 用户提交修改请求时，**则** 系统 **应** 验证输入格式（例如：用户名长度限制，手机号格式）。
2. **注意**：邮箱地址作为登录账号，**不** 允许通过此接口直接修改（通常需要单独的换绑流程）。
3. **当** 验证通过时，**则** 系统 **应** 更新数据库中的用户信息并记录更新时间。
4. **然后** 系统 **应** 返回更新后的最新用户信息。

### 需求 5：用户登出

**用户故事：** 作为已登录用户，我希望退出登录，以便使我当前的会话失效。

#### 验收标准

1. **当** 请求登出时，**则** 系统 **应** 将当前的 JTI (JWT ID) 添加到 Redis 的黑名单中，直到其自然过期。
2. **然后** 携带此 Token 的后续请求 **应** 被拒绝。

## 非功能需求

### 代码架构与模块化
- **领域驱动设计 (DDD)**：实现必须严格遵循 DDD 原则，分离 `Domain`（领域层）、`Application`（应用层）、`Interface`（接口层）和 `Infrastructure`（基础设施层）。
    - **领域层**：包含 `User` 聚合根、`Email` 值对象、`UserAuthenticationDomainService`。
    - **基础设施层**：处理 Redis (Token/限流) 和邮件发送实现。
- **单一职责**：每个服务（例如 `RateLimitDomainService`, `TokenService`）必须有单一的职责。
- **清晰接口**：应用层必须暴露 DTO 和 Command，而不是领域实体。

### 性能
- **限流检查**：响应时间 < 50ms（使用 Redis）。
- **Token 验证**：响应时间 < 10ms（无状态或快速缓存检查）。

### 安全性
- **数据保护**：密码必须使用 BCrypt 加密。
- **Token 安全**：Token 必须签名 (JWT) 并支持过期时间。
- **审计**：敏感操作（注册、登录）必须记录审计日志。

### 可靠性
- **重试机制**：邮件发送应支持重试或优雅的失败消息提示。
- **可用性**：认证服务应高可用；依赖项如 Redis 应具有回退或快速失败机制。

### 易用性
- **错误消息**：验证码错误、频率限制和凭据错误必须向客户端提供清晰（但在安全范围内）的反馈。

### 调试模式 (Debug Mode)
- **目的**：方便开发和测试阶段快速验证 API，无需每次请求都通过 JWT 认证。
- **机制**：
    - 在配置文件中设置 `AUTH_DEBUG_ENABLED: true` 开启。
    - 请求头携带 `AUTH_DEBUG_HEADER_NAME` (如 `debug-user`) 指定用户 ID。
    - 使用**工厂模式**实现请求拦截过滤：
        - 验证工厂应能提供 JWT 验证或 Debug 验证策略。
        - 只有当 `AUTH_DEBUG_ENABLED` 为 true 时，Debug 策略才生效。
    - **逻辑**：请求 -> 拦截器 -> 验证工厂 -> 
        - 尝试 JWT 验证 -> 通过 ? 放行 : 
        - 尝试 Debug 验证 (如开启) -> 检查 Header -> 查库确认用户存在 -> 通过 ? 放行 : 拒绝。
- **安全警告**：此模式仅限 `local` 或 `dev` 环境使用，**严禁**在 `prod` 环境开启。
