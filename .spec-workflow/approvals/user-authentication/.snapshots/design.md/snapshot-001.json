{
  "id": "snapshot_1768110902723_9yyg1yo59",
  "approvalId": "approval_1768110902711_t09w3wmby",
  "approvalTitle": "User Authentication Design",
  "version": 1,
  "timestamp": "2026-01-11T05:55:02.722Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 设计文档\r\n\r\n## 概述\r\n\r\n**用户认证模块** 采用领域驱动设计 (DDD) 架构，作为通用的支撑域（Generic Domain）。它负责处理所有与用户身份相关的逻辑，包括注册、登录、会话管理和安全防护，对外提供标准的 REST API 和内部 Java 接口。\r\n\r\n## 架构设计\r\n\r\n### 分层架构\r\n\r\n本模块遵循洋葱架构/六边形架构原则：\r\n\r\n- **接口层 (Interfaces)**: 处理 HTTP 请求 (`UserController`)，参数校验，DTO 转换。\r\n- **应用层 (Application)**: 编排业务流程 (`UserApplicationService`)，不包含核心业务规则，只负责协调领域服务和基础设施。\r\n- **领域层 (Domain)**: 包含核心业务逻辑。\r\n    - **聚合根**: `User` (管理密码、状态、个人信息)。\r\n    - **值对象**: `Email` (校验逻辑), `Credential` (加密逻辑)。\r\n    - **领域服务**: `UserAuthenticationDomainService` (核心认证流程), `RateLimitDomainService` (限流策略)。\r\n- **基础设施层 (Infrastructure)**: 实现技术细节。\r\n    - **Repository**: `UserRepositoryImpl` (MyBatis-Plus 实现)。\r\n    - **Port Impl**: `EmailServiceImpl`, `RedisTokenStore`。\r\n\r\n### 模块依赖\r\n```mermaid\r\ngraph TD\r\n    API[Interfaces Layer] --> App[Application Layer]\r\n    App --> Domain[Domain Layer]\r\n    App --> Infra[Infrastructure Layer]\r\n    Domain --> InfraInterfaces[Domain Ports]\r\n    Infra --> InfraInterfaces\r\n```\r\n\r\n## 组件与接口设计\r\n\r\n### 1. 接口层 (REST API)\r\n\r\n| 方法 | 路径 | 描述 | 请求 DTO | 响应 DTO |\r\n|------|------|------|----------|----------|\r\n| POST | `/client/user/email/sendCode` | 发送验证码 | `SendEmailCodeRequest` | `Void` |\r\n| POST | `/client/user/email/register` | 邮箱注册 | `RegisterByEmailRequest` | `UserLoginResponse` |\r\n| POST | `/client/user/login` | 用户登录 | `LoginRequest` | `UserLoginResponse` |\r\n| GET | `/client/user/info` | 获取用户信息 | - | `UserDetailDTO` |\r\n| POST | `/client/user/modify` | 修改用户信息 | `ModifyUserRequest` | `UserDetailDTO` |\r\n| POST | `/client/user/logout` | 用户登出 | - | `Void` |\r\n\r\n### 2. 应用层服务 (`UserApplicationService`)\r\n\r\n- `registerByEmail(cmd)`: 协调 `EmailVerificationDomainService` 验证验证码，调用 `UserAuthenticationDomainService` 创建用户，最后调用 `TokenService` 生成令牌。\r\n- `login(cmd)`: 调用 `AuthenticationDomainService` 验证凭据，成功后生成令牌。\r\n- `modifyInfo(cmd)`: 调用 `User` 聚合根更新信息，并持久化。\r\n\r\n### 3. 领域层模型 (`Domain Model`)\r\n\r\n#### User 聚合根\r\n```java\r\npublic class User {\r\n    private UserId id;\r\n    private String username;\r\n    private Email email;\r\n    private Credential credential;\r\n    private UserProfile profile; // 头像, 手机号等\r\n    \r\n    // 行为方法\r\n    public void changePassword(String oldPwd, String newPwd);\r\n    public void updateProfile(String newName, String newAvatar, String newPhone);\r\n    public boolean verifyPassword(String rawPassword);\r\n}\r\n```\r\n\r\n## 数据模型设计\r\n\r\n### 数据库 Schema\r\n\r\n引用 `库表设计.md` 中的 `user_info` 表设计。\r\n\r\n```sql\r\nCREATE TABLE IF NOT EXISTS `user_info` (\r\n    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',\r\n    `username` VARCHAR(50) NOT NULL COMMENT '用户名',\r\n    `email` VARCHAR(100) NOT NULL COMMENT '邮箱地址（登录账号）',\r\n    `password` VARCHAR(255) NOT NULL COMMENT 'BCrypt加密密码',\r\n    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',\r\n    `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',\r\n    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-正常',\r\n    `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',\r\n    `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',\r\n    `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-正常，1-已删除',\r\n    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',\r\n    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',\r\n    PRIMARY KEY (`id`),\r\n    UNIQUE KEY `uk_email` (`email`)\r\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';\r\n```\r\n\r\n## 安全与异常处理\r\n\r\n### 安全策略\r\n1.  **密码存储**: 必须使用 BCrypt 强哈希算法（Spring Security Crypto）。\r\n2.  **Token 管理**: 使用 JWT (JWS)，包含 `sub` (userId), `exp` (过期时间), `jti` (唯一ID)。\r\n3.  **并发控制**: 注册时使用数据库唯一索引防止邮箱重复。\r\n4.  **限流**: 使用 Redis `INCR` + `EXPIRE` 实现滑动窗口限流。\r\n\r\n### 异常处理\r\n*   `UserAlreadyExistsException` -> 409 Conflict\r\n*   `InvalidCredentialException` -> 401 Unauthorized (对外显示 generic message)\r\n*   `RateLimitExceededException` -> 429 Too Many Requests\r\n*   `ValidationException` -> 400 Bad Request\r\n\r\n## 测试策略\r\n\r\n### 单元测试\r\n*   **Domain**: 测试 `User` 聚合根的行为（如修改信息逻辑）、`Email` 值对象验证。\r\n*   **Service**: Mock Repository，测试 `UserAuthenticationDomainService` 的业务流。\r\n\r\n### 集成测试\r\n*   **Controller**: 使用 `@SpringBootTest` + `MockMvc` 测试完整的 HTTP 请求流程，验证 JSON 序列化和状态码。\r\n*   **Repository**: 使用 H2 或 Testcontainers 验证 SQL 执行正确性。\r\n",
  "fileStats": {
    "size": 5393,
    "lines": 118,
    "lastModified": "2026-01-11T05:55:00.720Z"
  },
  "comments": []
}