{
  "id": "snapshot_1768109782916_97njhsu37",
  "approvalId": "approval_1768109782881_r0rmbjnz6",
  "approvalTitle": "User Authentication Requirements",
  "version": 1,
  "timestamp": "2026-01-11T05:36:22.916Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document\r\n\r\n## Introduction\r\n\r\nThe **User Authentication Module (Identity Context)** is a generic domain module responsible for managing user identities and secure access to the AI-Agent platform. It provides essential capabilities including email-based verification, user registration, login via JWT tokens, and user session management.\r\n\r\n**Core Value:**\r\n- **Security**: Safeguard the platform against unauthorized access.\r\n- **Experience**: Provide a seamless and low-friction login experience.\r\n- **Protection**: Implement multi-dimensional security measures (Email verification, Rate limiting).\r\n\r\n## Alignment with Product Vision\r\n\r\nThis module serves as the foundational \"Identity Context\" for the entire AI-Agent system. By establishing a secure and reliable authentication mechanism, it enables:\r\n- **Personalized Agents**: Ensuring users can manage and access only their own agents.\r\n- **Secure Workflow Execution**: Authenticating requests to execute and manage workflows.\r\n- **Architecture Compliance**: Adhering to the DDD strategic design by isolating identity concerns into a separate bounded context.\r\n\r\n## Requirements\r\n\r\n### Requirement 1: Email Verification Code\r\n\r\n**User Story:** As a generic user, I want to receive a verification code via email, so that I can verify my identity for registration.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. **WHEN** a user requests a code with a valid email **THEN** separate rate limits are checked (Email: 1/min, IP: 10/hour, Device: 5/hour).\r\n2. **IF** rate limits are exceeded **THEN** the system **SHALL** return a specific error indicating the limit reached.\r\n3. **WHEN** checks pass **THEN** the system **SHALL** generation a 6-digit code, store it with 5-minute expiration, and trigger an email dispatch.\r\n4. **WHEN** the email service fails **THEN** the system **SHALL** return a retryable error status.\r\n\r\n### Requirement 2: User Registration\r\n\r\n**User Story:** As a new user, I want to register an account using my email and verification code, so that I can access the platform.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. **WHEN** submitting registration details (email, code, password) **THEN** the system **SHALL** validate the verification code matches and is not expired.\r\n2. **IF** the email is already registered **THEN** the system **SHALL** return a \"User already exists\" error.\r\n3. **WHEN** validation succeeds **THEN** the system **SHALL** create a new User aggregate, encrypt the password using BCrypt, and persist the user.\r\n4. **THEN** the system **SHALL** automatically generate and return a valid JWT token upon successful registration.\r\n\r\n### Requirement 3: User Login\r\n\r\n**User Story:** As a registered user, I want to log in with my email and password, so that I can obtain an access token.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. **WHEN** submitting email and password **THEN** the system **SHALL** verify credentials against the stored hash.\r\n2. **IF** authentication fails **THEN** the system **SHALL** return a generic \"Invalid credentials\" error to prevent enumeration.\r\n3. **WHEN** authentication succeeds **THEN** the system **SHALL** record the login IP and time.\r\n4. **THEN** the system **SHALL** return a JWT token containing the user ID.\r\n\r\n### Requirement 4: Get User Info\r\n\r\n**User Story:** As a logged-in user, I want to view my profile information, so that I can confirm my identity.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. **WHEN** requesting user info with a valid JWT token **THEN** the system **SHALL** return the user's ID, username, email, and phone.\r\n2. **IF** the token is invalid or expired **THEN** the system **SHALL** return a 401 Unauthorized response.\r\n\r\n### Requirement 5: User Logout\r\n\r\n**User Story:** As a logged-in user, I want to log out, so that my current session is invalidated.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. **WHEN** requesting logout **THEN** the system **SHALL** add the current JTI (JWT ID) to a deny-list (blacklist) in Redis until its natural expiration.\r\n2. **THEN** subsequent requests with this token **SHALL** be rejected.\r\n\r\n## Non-Functional Requirements\r\n\r\n### Code Architecture and Modularity\r\n- **Domain-Driven Design**: The implementation must strictly follow DDD principles, separating `Domain`, `Application`, `Interface`, and `Infrastructure` layers.\r\n    - **Domain**: Contains `User` aggregate, `Email` value object, `UserAuthenticationDomainService`.\r\n    - **Infrastructure**: Handles Redis (Token/RateLimit) and Email sending implementation.\r\n- **Single Responsibility**: Each service (e.g., `RateLimitDomainService`, `TokenService`) must have a single responsibility.\r\n- **Clear Interfaces**: Application layer must expose DTOs and Commands, not Domain Entities.\r\n\r\n### Performance\r\n- **Rate Limit Check**: Response time < 50ms (using Redis).\r\n- **Token Validation**: Response time < 10ms (stateless or fast cache check).\r\n\r\n### Security\r\n- **Data Protection**: Passwords must be encrypted using BCrypt.\r\n- **Token Security**: Tokens must be signed (JWT) and support expiration.\r\n- **Audit**: Sensitive operations (Registration, Login) must log audit trails.\r\n\r\n### Reliability\r\n- **Retry Mechanism**: Email sending should support retries or graceful failure messaging.\r\n- **Availability**: The authentication service should be highly available; dependencies like Redis should have fallbacks or fail-fast mechanisms.\r\n\r\n### Usability\r\n- **Error Messages**: Verification code errors, frequency limits, and credential errors must provide clear (but secure) feedback to the client.\r\n",
  "fileStats": {
    "size": 5518,
    "lines": 96,
    "lastModified": "2026-01-11T05:36:20.895Z"
  },
  "comments": []
}