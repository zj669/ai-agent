{
  "id": "snapshot_1768126168142_d5776rk8t",
  "approvalId": "approval_1768126168075_crinvo9oa",
  "approvalTitle": "Intelligent Chat Tasks (Refactored to Standard)",
  "version": 1,
  "timestamp": "2026-01-11T10:09:28.142Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document\r\n\r\n- [ ] 1. Define Data Models and Persistence for Node Execution Logs\r\n  - File: ai-agent-domain/src/main/java/com/zj/aiagent/domain/workflow/entity/WorkflowNodeExecutionLog.java\r\n  - Define `WorkflowNodeExecutionLog` entity with fields for inputs, outputs, renderMode\r\n  - Create repository interface `WorkflowNodeExecutionLogRepository`\r\n  - Implement repository in infrastructure layer\r\n  - Purpose: Persist detailed execution logs for debug and history\r\n  - _Requirements: 2.3, 4.1_\r\n  - _Prompt: Role: Java Backend Developer | Task: Create WorkflowNodeExecutionLog entity and repository following DDD patterns | Restrictions: Use JPA/MyBatis as appropriate, ensure JSON fields for inputs/outputs | Success: Entity and Repository are created and compile_\r\n\r\n- [ ] 2. Implement Redis SSE Publisher and Subscriber\r\n  - File: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/workflow/event/RedisSsePublisher.java\r\n  - Implement `RedisSsePublisher` to publish `SseEventPayload` to Redis endpoint\r\n  - Implement `RedisSseListener` (or `MessageListenerAdapter`) to receive messages\r\n  - Purpose: Enable distributed event routing for SSE\r\n  - _Requirements: 2.1, 3.0_\r\n  - _Prompt: Role: Java Spring Developer | Task: Implement Redis Pub/Sub for SSE events. Create Publisher to send events and Listener to receive them. | Context: Channel name format `workflow:channel:{executionId}`. | Success: Messages can be published and received via Redis_\r\n\r\n- [ ] 3. Refactor WorkflowController for Direct POST Streaming\r\n  - File: ai-agent-interfaces/src/main/java/com/zj/aiagent/interfaces/workflow/WorkflowController.java\r\n  - Change `/start` endpoint to return `SseEmitter` immediately\r\n  - Subscribe to Redis channel on request start\r\n  - Implement `POST /stop` for cancellation\r\n  - Purpose: Fix race conditions and support real-time streaming\r\n  - _Requirements: 2.1, 4.1, 4.2_\r\n  - _Prompt: Role: Java Spring WebFlow Developer | Task: Refactor WorkflowController.startExecution to return SseEmitter. trigger scheduler.startExecution consistently. | Restrictions: Ensure SseEmitter timeout is set to 30m. | Success: API returns text/event-stream immediately_\r\n\r\n- [ ] 4. Implement Scheduler Integration\r\n  - File: ai-agent-application/src/main/java/com/zj/aiagent/application/workflow/SchedulerService.java\r\n  - Publish `NodeStarted`, `NodeCompleted` events using `RedisSsePublisher`\r\n  - Add termination check for `POST /stop` (Cancellation)\r\n  - Purpose: Connect core scheduler execution with the Event Stream\r\n  - _Requirements: 2.1, 4.2_\r\n  - _Prompt: Role: Backend Logic Developer | Task: Update SchedulerService to publish events to RedisSsePublisher during node execution. Add check for cancellation flag. | Success: Events are published during DAG traversal_\r\n\r\n- [ ] 5. Implement History and Debug APIs\r\n  - File: ai-agent-interfaces/src/main/java/com/zj/aiagent/interfaces/workflow/WorkflowController.java\r\n  - Implement `GET /history/{conversationId}`\r\n  - Implement `GET /execution/{executionId}/node/{nodeId}`\r\n  - Purpose: Provide data for Chat UI history and Debug sidepanel\r\n  - _Requirements: 2.2, 2.3_\r\n  - _Prompt: Role: API Developer | Task: Implement endpoints for fetching conversation history and node execution details from repository. | Success: APIs return correct JSON structure defined in design_\r\n",
  "fileStats": {
    "size": 3358,
    "lines": 44,
    "lastModified": "2026-01-11T10:09:09.802Z"
  },
  "comments": []
}