{
  "id": "snapshot_1768118282047_ixtpv22ys",
  "approvalId": "approval_1768118282035_fykcfg1p6",
  "approvalTitle": "Agent Management Design Spec",
  "version": 1,
  "timestamp": "2026-01-11T07:58:02.047Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# 设计文档 - Agent 管理模块\r\n\r\n## 概述\r\n\r\nAgent 管理模块负责 AI Agent 的全生命周期管理，包括创建、配置、发布、版本控制和查询。它位于支撑域（Supporting Domain），为上层的交互域和核心的工作流编排域提供 Agent 定义数据。\r\n\r\n## 技术标准对齐\r\n\r\n### 领域驱动设计 (DDD)\r\n- 遵循 DDD 分层架构：Interfaces -> Application -> Domain -> Infrastructure。\r\n- 只有 Domain 层包含核心业务逻辑（Agent 聚合根）。\r\n- 使用 MyBatis 实现 Repository 模式，隔离数据库实现细节。\r\n\r\n### 项目结构复用\r\n- 复用现有的 `Response` 统一响应结构。\r\n- 复用 `JwtAuthStrategy` 获取当前登录用户信息（`UserContext`）。\r\n- 遵循现有的包结构 `com.zj.aiagent`。\r\n\r\n## 架构设计\r\n\r\n### 模块结构\r\n\r\n```mermaid\r\ngraph TD\r\n    API[AgentController] -->|DTO| AppService[AgentApplicationService]\r\n    AppService -->|Entities| Domain[Agent Aggregate]\r\n    AppService -->|Commands| Repository[AgentRepository]\r\n    Domain -->|Rules| Status[AgentStatus]\r\n    Repository -->|PO| Infra[AgentRepositoryImpl]\r\n    Infra -->|SQL| Mapper[AgentMapper]\r\n    Infra --> DB[(MySQL)]\r\n```\r\n\r\n### 核心设计原则\r\n1. **聚合一致性**：`Agent` 聚合根保证内部状态（如 Status 与 Version）的一致性。发布操作必须原子性地更新状态并生成版本记录。\r\n2. **读写分离**：\r\n    - 列表查询（Query）直接通过 MyBatis Mapper 返回 DTO/PO，避免加载大字段 `graphJson`。\r\n    - 详情查询和核心业务逻辑（Command）通过 Repository 加载完整聚合根。\r\n3. **不可变版本**：`AgentVersion` 一旦创建不可修改，保证线上运行的工作流稳定性。\r\n\r\n## 组件设计\r\n\r\n### 1. Domain Layer (领域层)\r\n\r\n#### Aggregate Root: `Agent`\r\n- **职责**：封装 Agent 业务逻辑。\r\n- **属性**：\r\n    - `id`: Long\r\n    - `userId`: Long\r\n    - `name`: String\r\n    - `graphJson`: String (核心业务字段)\r\n    - `status`: AgentStatus\r\n    - `publishedVersionId`: Long\r\n- **行为**：\r\n    - `create(userId, name, graph)`: 工厂方法\r\n    - `updateConfig(name, desc, graph)`: 更新草稿\r\n    - `publish()`: 生成版本快照，切换状态\r\n    - `delete()`: 标记删除\r\n\r\n#### Entity: `AgentVersion`\r\n- **职责**：记录已发布版本的快照。\r\n- **属性**：\r\n    - `id`: Long\r\n    - `agentId`: Long\r\n    - `version`: Integer\r\n    - `graphSnapshot`: String (不可变)\r\n\r\n#### Repository Interface: `AgentRepository`\r\n- `save(Agent)`\r\n- `findById(id)`\r\n- `delete(id)`\r\n- `findByUserId(userId)` (用于列表查询优化)\r\n\r\n### 2. Infrastructure Layer (基础设施层)\r\n\r\n#### `AgentRepositoryImpl`\r\n- **职责**：MyBatis 与 DDD 实体转换。\r\n- **实现**：\r\n    - `AgentPO` <-> `Agent` 转换。\r\n    - 处理 `agent_info` 和 `agent_version` 两张表的事务操作。\r\n\r\n#### MyBatis Mapper\r\n- `AgentMapper`: 处理 `agent_info` 表 CRUD。\r\n- `AgentVersionMapper`: 处理 `agent_version` 表 Insert 和 Query。\r\n\r\n### 3. Application Layer (应用层)\r\n\r\n#### `AgentApplicationService`\r\n- **职责**：编排领域对象，处理事务。\r\n- **方法**：\r\n    - `createAgent(cmd)`\r\n    - `updateAgent(cmd)`\r\n    - `publishAgent(id)`\r\n    - `deleteAgent(id)`\r\n    - `getAgentDetail(id)`\r\n    - `getUserAgentList(userId)`\r\n\r\n### 4. Interface Layer (接口层)\r\n\r\n#### `AgentController`\r\n- **路径**：`/client/agent`\r\n- **Endpoints**:\r\n    - `GET /list`: 返回 `List<AgentListRespDTO>` (不含 graphJson)\r\n    - `GET /{id}`: 返回 `AgentDetailRespDTO` (含 graphJson)\r\n    - `POST /save`: 处理创建/更新\r\n    - `POST /{id}/publish`\r\n    - `DELETE /{id}`\r\n\r\n## 数据模型\r\n\r\n### 数据库 Schema (对应 `agent_info`)\r\n- `id`: BIGINT PK\r\n- `user_id`: BIGINT NOT NULL\r\n- `name`: VARCHAR(100)\r\n- `status`: TINYINT (0:DRAFT, 1:PUBLISHED, 2:DISABLED)\r\n- `graph_json`: LONGTEXT\r\n- `published_version_id`: BIGINT (Current active version)\r\n\r\n### DTOs\r\n- `AgentSaveReqDTO`: `{ id?, name, description, graphJson }`\r\n- `AgentListRespDTO`: `{ id, name, status, updateTime }`\r\n- `AgentDetailRespDTO`: `{ id, name, description, status, graphJson, createTime, updateTime }`\r\n\r\n## 错误处理\r\n\r\n1. **权限不足**\r\n   - **场景**：用户尝试操作他人的 Agent。\r\n   - **处理**：ApplicationService 层校验 `agent.isOwnedBy(currentUser)`，失败抛出 `AccessDeniedException` (403)。\r\n\r\n2. **状态冲突**\r\n   - **场景**：发布已停用的 Agent。\r\n   - **处理**：Domain 层 `publish()` 方法校验当前状态，抛出 `DomainException`。\r\n\r\n3. **数据校验**\r\n   - **场景**：GraphJson 格式非法。\r\n   - **处理**：ApplicationService 调用校验工具类，失败抛出 `ValidationException` (400)。\r\n\r\n## 测试策略\r\n\r\n### 单元测试\r\n- **AgentDomainTest**: 测试聚合根行为（发布逻辑、状态流转）。\r\n- **AgentApplicationServiceTest**: Mock Repository，测试业务流程编排。\r\n\r\n### 集成测试\r\n- **AgentRepositoryTest**: 使用 H2 内存数据库测试 MyBatis 映射正确性。\r\n- **AgentControllerTest**: Mock Service，测试 API 参数校验和响应格式。\r\n",
  "fileStats": {
    "size": 5151,
    "lines": 147,
    "lastModified": "2026-01-11T07:58:00.046Z"
  },
  "comments": []
}