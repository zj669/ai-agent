{
  "id": "snapshot_1768123453717_d9wi1dlnl",
  "approvalId": "approval_1768123453608_o46fjnz2i",
  "approvalTitle": "Workflow Orchestration Tasks",
  "version": 1,
  "timestamp": "2026-01-11T09:24:13.717Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks Document - Workflow Orchestration\r\n\r\n- [ ] 1. Define Core Domain Entities & Value Objects\r\n  - File: `ai-agent-domain/src/main/java/com/zj/aiagent/domain/workflow/entity/Execution.java`, `Node.java`, `WorkflowGraph.java`\r\n  - File: `ai-agent-domain/src/main/java/com/zj/aiagent/domain/workflow/vo/ExecutionContext.java`, `NodeExecutionResult.java`\r\n  - Implement the `Execution` aggregate root, `Node` entity, and `ExecutionContext` VO.\r\n  - **Constraint**: `ExecutionContext` must include SpEL resolution logic (`resolveInput(Map<String, Object> inputs)`).\r\n  - _Leverage: com.zj.aiagent.common.enums.ExecutionStatus_\r\n  - _Requirements: 1.1, 4.1_\r\n  - _Prompt: Implement core domain entities for Workflow Orchestration. Execution aggregate must manage state transitions and references to ExecutionContext. NodeExecutionResult should support generic outputs and selectedBranchId._\r\n\r\n- [ ] 2. Define Node Execution Strategy Interface\r\n  - File: `ai-agent-domain/src/main/java/com/zj/aiagent/domain/workflow/port/NodeExecutorStrategy.java`\r\n  - Define the Async Strategy Interface: `CompletableFuture<NodeExecutionResult> executeAsync(Node node, Map<String, Object> inputVariables)`.\r\n  - Purpose: Decouple scheduling from execution.\r\n  - _Requirements: 2.1_\r\n\r\n- [ ] 3. Implement Infrastructure Configuration (ThreadPool & Redisson)\r\n  - File: `ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/config/WorkflowConfig.java`\r\n  - Configure `ThreadPoolTaskExecutor` (\"nodeExecutorThreadPool\") for IO-intensive tasks.\r\n  - Configure `RedissonClient` bean (if not already present) for distributed locks.\r\n  - _Requirements: Non-functional (Concurrency)_\r\n\r\n- [ ] 4. Implement Infrastructure Strategies (LLM & HTTP)\r\n  - File: `ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/workflow/executor/LlmNodeExecutorStrategy.java`\r\n  - File: `ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/workflow/executor/HttpNodeExecutorStrategy.java`\r\n  - Implement `executeAsync` using `CompletableFuture.supplyAsync` with the custom thread pool.\r\n  - LLM Strategy: Integrate with Spring AI.\r\n  - HTTP Strategy: Use `WebClient` or `RestTemplate`.\r\n  - _Requirements: 2.2_\r\n\r\n- [ ] 5. Implement Scheduler Service (Core Logic)\r\n  - File: `ai-agent-domain/src/main/java/com/zj/aiagent/domain/workflow/service/SchedulerService.java`\r\n  - Implement DAG traversal, In-Degree calculation, and Parallel Dispatching.\r\n  - **Critical**: Implement `onNodeComplete` callback with **Redisson Distributed Lock** to effectively serialize `Execution.advance()`.\r\n  - **Critical**: Implement Branch Pruning logic (mark skipped keys recursively) in `advance()`.\r\n  - _Requirements: 2.1, 2.2, 3.1_\r\n\r\n- [ ] 6. Implement Persistence Layer\r\n  - File: `ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/workflow/repository/RedisCheckpointRepository.java`\r\n  - Implement save/load of `Execution` aggregate to Redis.\r\n  - Ensure atomicity of state updates.\r\n  - _Requirements: 4.2_\r\n\r\n- [ ] 7. Implement REST API for Execution Control\r\n  - File: `ai-agent-interfaces/src/main/java/com/zj/aiagent/interfaces/workflow/WorkflowController.java`\r\n  - Endpoints: `POST /execution/start`, `POST /execution/resume`.\r\n  - _Requirements: 5.1_\r\n\r\n- [ ] 8. Integration Testing (End-to-End)\r\n  - File: `ai-agent-interfaces/src/test/java/com/zj/aiagent/interfaces/workflow/WorkflowExecutionTest.java`\r\n  - Test a full flow: Start -> Condition (Branch A) -> LLM -> Join -> End.\r\n  - Verify SSE events and final output.\r\n  - _Requirements: All_\r\n",
  "fileStats": {
    "size": 3568,
    "lines": 55,
    "lastModified": "2026-01-11T09:24:08.992Z"
  },
  "comments": []
}