{
  "id": "snapshot_1768121702915_t6a6yc1dz",
  "approvalId": "approval_1768121702880_k83f44kh3",
  "approvalTitle": "Workflow Orchestration Requirements",
  "version": 1,
  "timestamp": "2026-01-11T08:55:02.915Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Requirements Document: Workflow Orchestration\r\n\r\n## Introduction\r\n\r\nThe Workflow Orchestration module (Core Domain) provides the capability to define and execute DAG (Directed Acyclic Graph) based workflows. It serves as the engine for AI Agents, supporting various node types (LLM, Tool, Condition, Human) and managing execution state (Pause, Resume, Checkpoint).\r\n\r\n## Alignment with Product Vision\r\n\r\nThis module implements the core value proposition of the AI Agent platform: flexible and reliable agent execution. It enables complex task automation, human-in-the-loop workflows, and long-running processes via checkpointing.\r\n\r\n## Requirements\r\n\r\n### Requirement 1: Execute Workflow (DAG)\r\n\r\n**User Story:** As a User, I want to execute an Agent defined by a DAG so that I can automate complex tasks.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN `Execution.start(graph, inputs)` is called THEN the system SHALL validate the graph structure (DAG check).\r\n2. WHEN the workflow starts THEN the system SHALL identify all start nodes and schedule them.\r\n3. WHEN a node completes THEN the system SHALL identify successor nodes whose dependencies are met and schedule them.\r\n4. WHEN all nodes complete THEN the system SHALL mark the Execution as COMPLETED.\r\n5. IF a node fails THEN the system SHALL follow the defined `RetryPolicy`.\r\n6. WHEN a node starts, streams, or completes THEN the system SHALL publish `ExecutionEvent` (for SSE).\r\n\r\n### Requirement 2: Checkpoint & State Management\r\n\r\n**User Story:** As a System, I want to save the execution state after every node completion so that I can recover from failures or resume from pauses.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN a node finishes execution THEN the system SHALL create a `Checkpoint` containing the current `ExecutionContext` snapshot.\r\n2. The `ExecutionContext` SHALL store inputs, outputs, and shared state data.\r\n3. The `Checkpoint` SHALL be persisted to the `CheckpointRepository`.\r\n\r\n### Requirement 3: Human Intervention (Pause/Resume)\r\n\r\n**User Story:** As a User, I want the workflow to pause at specific nodes so that I can review and approve sensitive actions.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. WHEN the scheduler encounters a `HUMAN` type node THEN it SHALL update Execution state to `PAUSED` and stop scheduling new nodes.\r\n2. WHEN paused THEN the system SHALL publish an `ExecutionPausedEvent`.\r\n3. WHEN `Execution.resume()` is called with approval THEN the system SHALL load the latest checkpoint and schedule the paused node to continue (or skip depending on logic).\r\n\r\n### Requirement 4: Node Types Support\r\n\r\n**User Story:** As a Developer, I want to use different node types to build rich workflows.\r\n\r\n#### Acceptance Criteria\r\n\r\n1. The system SHALL support `START`, `END` nodes.\r\n2. The system SHALL support `LLM` nodes (call AI models).\r\n3. The system SHALL support `HUMAN` nodes (pause for review).\r\n4. The system SHALL support `CONDITION` nodes (route based on expressions).\r\n5. The system SHALL support `PARALLEL` execution of independent nodes.\r\n\r\n## Non-Functional Requirements\r\n\r\n### Code Architecture and Modularity\r\n- **Domain-Driven Design**: Core logic must reside in `com.zj.aiagent.domain.workflow`.\r\n- **Infrastructure Ignorance**: Domain layer must use ports (`CheckpointRepository`, `ExecutionEventPublisher`) and not depend on Redis/Web directly.\r\n\r\n### Performance\r\n- Node scheduling overhead < 50ms.\r\n- Checkpoint persistence < 100ms.\r\n\r\n### Reliability\r\n- At-least-one execution guarantee for nodes (idempotency required in checking).\r\n- State consistency: Checkpoints must be atomic with node completion.\r\n",
  "fileStats": {
    "size": 3609,
    "lines": 71,
    "lastModified": "2026-01-11T08:54:44.549Z"
  },
  "comments": []
}