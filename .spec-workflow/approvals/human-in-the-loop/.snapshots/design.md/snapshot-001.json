{
  "id": "snapshot_1768233654464_nq6uw0eu8",
  "approvalId": "approval_1768233654416_1wb6j1d4j",
  "approvalTitle": "Human in the Loop Design",
  "version": 1,
  "timestamp": "2026-01-12T16:00:54.464Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Human-in-the-Loop Design Document\r\n\r\n## Overview\r\n\r\nThe Human-in-the-Loop feature enables an AI Agent workflow to pause execution at specific nodes, allowing human operators to review, modify, and approve/reject the execution before it proceeds. This design introduces a new `PAUSED_FOR_REVIEW` state, a dedicated `HumanReviewRecord` for audit trails, and a `TriggerPhase` configuration to distinguish between pre-approval (modifying inputs) and post-approval (modifying outputs).\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (tech.md)\r\n*   **Domain-Driven Design**: Uses a rich domain model (`HumanReviewRecord` entity, `Execution` aggregate root logic) to encapsulate business rules.\r\n*   **Layered Architecture**: Strictly separates API (Interface), Service (Application), and Entity (Domain) layers.\r\n*   **Immutable Logs**: Audit records are designed as immutable ledger entries.\r\n\r\n### Project Structure (structure.md)\r\n*   Entities in `ai-agent-domain/.../entity`\r\n*   Repositories in `ai-agent-infrastructure`\r\n*   Controllers in `ai-agent-interfaces` with DTOs\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n*   **`Execution` (Aggregate Root)**: Will be extended to handle `reviews` and state transitions.\r\n*   **`SchedulerService`**: Reuse existing node scheduling and locking mechanisms (`Redisson`).\r\n*   **`RedisSseListener`**: Reuse for real-time `workflow_paused` and `workflow_resumed` notifications.\r\n*   **`ExecutorFactory`**: Reuse for resuming execution strategies.\r\n\r\n### Integration Points\r\n*   **`ExecutionRepository`**: Will need to persist the new state.\r\n*   **`HumanReviewRepository`**: New integration for storing review logs.\r\n\r\n## Architecture\r\n\r\n```mermaid\r\nclassDiagram\r\n    class Execution {\r\n        +ExecutionStatus status\r\n        +String pausedNodeId\r\n        +Integer version\r\n        +resume(nodeId, inputs, outputs)\r\n    }\r\n    class HumanReviewConfig {\r\n        +boolean enabled\r\n        +TriggerPhase triggerPhase\r\n    }\r\n    class HumanReviewRecord {\r\n        +String executionId\r\n        +String nodeId\r\n        +ReviewDecision decision\r\n        +String originalContext\r\n        +String modifiedContext\r\n    }\r\n    class SchedulerService {\r\n        +resumeExecution()\r\n        +getPendingReviews()\r\n    }\r\n    class HumanReviewController {\r\n        +getPendingReviews()\r\n        +getReviewDetail()\r\n        +resume()\r\n    }\r\n\r\n    Execution \"1\" *-- \"1\" ExecutionStatus\r\n    Execution \"1\" *-- \"*\" HumanReviewRecord\r\n    Node \"1\" *-- \"1\" HumanReviewConfig\r\n    SchedulerService ..> Execution : manages\r\n    SchedulerService ..> HumanReviewRepository : uses\r\n    HumanReviewController ..> SchedulerService : delegates\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### Domain Layer\r\n\r\n#### `ExecutionStatus` (Enum)\r\n*   **Add**: `PAUSED_FOR_REVIEW (10)`\r\n\r\n#### `TriggerPhase` (Enum)\r\n*   **Values**: `BEFORE_EXECUTION`, `AFTER_EXECUTION`\r\n\r\n#### `HumanReviewRecord` (Entity)\r\n*   **Fields**: `id`, `executionId`, `nodeId`, `reviewerId`, `decision`, `triggerPhase`, `originalData` (JSON), `modifiedData` (JSON), `comment`, `reviewedAt`.\r\n\r\n#### `HumanReviewRepository` (Interface)\r\n*   `save(HumanReviewRecord record)`\r\n*   `findByExecutionId(String executionId)`\r\n*   `findPendingByUserId(Long userId, Pageable pageable)`\r\n\r\n### Application Service\r\n\r\n#### `SchedulerService`\r\n*   **`checkPause(Execution execution, Node node, TriggerPhase phase)`**:\r\n    *   Determines if execution should pause.\r\n    *   Publishes `workflow_paused` event.\r\n*   **`resumeExecution(ResumeCommand cmd)`**:\r\n    *   Verifies optimistic lock (`version`).\r\n    *   Persists `HumanReviewRecord`.\r\n    *   Updates `Execution.context`.\r\n    *   Publishes `workflow_resumed` event.\r\n    *   Dispatches next step (Execute Node or Advance Node).\r\n\r\n### Interface Layer\r\n\r\n#### `HumanReviewController`\r\n*   `GET /pending-review`: Returns lightweight `PendingReviewDTO` list.\r\n*   `GET /pending-review-detail/{executionId}`: Returns `ReviewDetailDTO` with full context.\r\n*   `POST /resume`: Accepts `ResumeExecutionRequest` (includes version, edits).\r\n*   `GET /history`: Returns `HumanReviewRecord` list.\r\n\r\n## Data Models\r\n\r\n### Database Schema (MySQL)\r\n\r\n```sql\r\nCREATE TABLE `workflow_human_review_record` (\r\n  `id` bigint NOT NULL AUTO_INCREMENT,\r\n  `execution_id` varchar(64) NOT NULL,\r\n  `node_id` varchar(64) NOT NULL,\r\n  `reviewer_id` bigint NOT NULL,\r\n  `decision` varchar(20) NOT NULL, -- APPROVE, REJECT\r\n  `trigger_phase` varchar(20) NOT NULL, -- BEFORE, AFTER\r\n  `original_data` json DEFAULT NULL, -- Snapshot of Input or Output\r\n  `modified_data` json DEFAULT NULL,\r\n  `comment` varchar(500),\r\n  `reviewed_at` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  PRIMARY KEY (`id`),\r\n  KEY `idx_exec_node` (`execution_id`, `node_id`),\r\n  KEY `idx_reviewer` (`reviewer_id`)\r\n);\r\n```\r\n\r\n## Error Handling\r\n\r\n### Concurrent Review\r\n*   **Scenario**: Two admins review the same task.\r\n*   **Handling**: Optimistic Lock (`version` check). Second request fails with `409 Conflict`.\r\n*   **User Impact**: \"Task has been updated by another user.\"\r\n\r\n### Invalid State Resume\r\n*   **Scenario**: User tries to resume a `RUNNING` or `TERMINATED` execution.\r\n*   **Handling**: `400 Bad Request` - \"Execution is not paused for review.\"\r\n\r\n## Testing Strategy\r\n\r\n### Unit Testing\r\n*   **`ExecutionTest`**: Verify state transitions (RUNNING -> PAUSED_FOR_REVIEW -> RUNNING).\r\n*   **`SchedulerServiceTest`**: Mock Repository, verify `resumeExecution` handles edits and persistence correctly.\r\n\r\n### Integration Testing\r\n*   **Flow Test**: Start workflow -> Pause at Node A -> API List -> API Resume -> Verify Node B execution.\r\n*   **Concurrency Test**: Simulate parallel resume requests, verify optimistic locking.\r\n",
  "fileStats": {
    "size": 5755,
    "lines": 151,
    "lastModified": "2026-01-12T16:00:52.490Z"
  },
  "comments": []
}