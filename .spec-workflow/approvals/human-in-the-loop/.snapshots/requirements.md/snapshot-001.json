{
  "id": "snapshot_1768233081857_p8n5fgz2z",
  "approvalId": "approval_1768233081784_x87j8ab0b",
  "approvalTitle": "Human in the Loop Requirements",
  "version": 1,
  "timestamp": "2026-01-12T15:51:21.856Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# PRD: 人工审核（Human-in-the-Loop）API\r\n\r\n## 1. 背景与目标\r\n\r\n### 1.1 业务背景\r\n当前工作流系统支持全自动执行，但缺乏人机协同能力。根据 `05-人工审核模块需求.md`，关键业务节点需要支持：\r\n- 人工审核/干预\r\n- 结果修正与补充\r\n- 审批通过后继续执行\r\n\r\n### 1.2 目标\r\n提供完整的人工审核 API，支持工作流在特定节点暂停、等待人工决策、并根据审核结果继续/终止执行。\r\n\r\n---\r\n\r\n## 2. 功能需求\r\n\r\n### 2.1 核心功能\r\n| 功能 | 优先级 | 描述 |\r\n|------|--------|------|\r\n| 恢复/审批执行 | P0 | 提交人工审核决策，唤醒暂停的工作流 |\r\n| 获取待审核列表 | P0 | 查询当前用户（通常为 Agent 创建者）待处理的暂停任务 |\r\n| 审核历史记录 | P1 | 查看某个执行的所有审核记录 |\r\n\r\n### 2.2 用户故事\r\n- **作为运营人员**，我希望在 Agent 生成敏感内容后，能够人工审核并修改，然后继续执行后续节点。\r\n- **作为管理员**，我希望看到所有待审核的任务队列，按优先级处理。\r\n\r\n---\r\n\r\n## 3. API 设计\r\n\r\n### 3.1 恢复/审批执行\r\n\r\n**POST** `/api/workflow/execution/resume`\r\n\r\n#### 请求体\r\n```json\r\n{\r\n  \"executionId\": \"exec-uuid-123\",\r\n  \"version\": 5,   // [新增] 乐观锁控制，必填。防止多人并发审核冲突。\r\n  \"decision\": \"APPROVE\",  // enum: APPROVE, REJECT\r\n  \"nodeId\": \"node-001\",\r\n  \"edits\": {\r\n    \"output\": \"修改后的内容\" // [注意] 若提供了 edits，将覆盖原节点 Context 中的 Output\r\n  },\r\n  \"comment\": \"修改了敏感词汇\"\r\n}\r\n```\r\n\r\n#### 响应\r\n```json\r\n{\r\n  \"success\": true,\r\n  \"message\": \"Execution resumed\",\r\n  \"executionId\": \"exec-uuid-123\"\r\n}\r\n```\r\n\r\n#### 状态码\r\n- 200: 成功\r\n- 404: 执行不存在\r\n- 400: 执行状态不是 PAUSED_FOR_REVIEW 或 版本冲突\r\n- 403: 无权限审核\r\n\r\n### 3.2 获取待审核任务列表\r\n\r\n**GET** `/api/workflow/execution/pending-review`\r\n\r\n#### Query 参数\r\n- `userId`: 当前用户 ID（可选，默认当前登录用户）\r\n- `page`: 页码（默认 1）\r\n- `size`: 每页数量（默认 20）\r\n\r\n*权限说明：默认仅 Agent 的 Owner (创建者) 有权查询并审核其下的任务。*\r\n\r\n#### 响应\r\n```json\r\n{\r\n  \"total\": 5,\r\n  \"list\": [\r\n    {\r\n      \"executionId\": \"exec-uuid-123\",\r\n      \"agentId\": 1,\r\n      \"agentName\": \"客服助手\",\r\n      \"nodeId\": \"node-001\",\r\n      \"nodeName\": \"内容审核\",\r\n      \"pausedAt\": \"2026-01-12T15:30:00Z\",\r\n      \"context\": {\r\n        \"userQuery\": \"...\",\r\n        \"draftOutput\": \"...\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n### 3.3 审核历史记录（可选 P1）\r\n\r\n**GET** `/api/workflow/execution/{executionId}/review-history`\r\n\r\n#### 响应\r\n```json\r\n{\r\n  \"executionId\": \"exec-uuid-123\",\r\n  \"reviews\": [\r\n    {\r\n      \"nodeId\": \"node-001\",\r\n      \"reviewer\": \"admin@example.com\",\r\n      \"decision\": \"APPROVE\",\r\n      \"originalOutput\": \"...\",\r\n      \"modifiedOutput\": \"...\",\r\n      \"comment\": \"修改了敏感词汇\",\r\n      \"reviewedAt\": \"2026-01-12T15:35:00Z\"\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n---\r\n\r\n## 4. 领域模型影响\r\n\r\n### 4.1 执行状态扩展\r\n需要在 `ExecutionStatus` 枚举中增加：\r\n```java\r\nPAUSED_FOR_REVIEW  // 暂停等待人工审核\r\n```\r\n\r\n**状态流转约束**：\r\n- `RUNNING` -> `PAUSED_FOR_REVIEW`: 当遇到配置了 `requiresHumanReview` 的节点时流转。\r\n- `PAUSED_FOR_REVIEW` -> `RUNNING`: 审核通过 (APPROVE) 后流转。\r\n- `PAUSED_FOR_REVIEW` -> `TERMINATED`/`FAILED`: 审核拒绝 (REJECT) 后流转。\r\n\r\n### 4.2 审核记录实体 (Immutable)\r\n\r\n建议采用不可变设计，作为审计日志。\r\n\r\n**Schema (MySQL)**:\r\n```sql\r\nCREATE TABLE `workflow_review_log` (\r\n  `id` bigint NOT NULL AUTO_INCREMENT,\r\n  `execution_id` varchar(64) NOT NULL,\r\n  `node_id` varchar(64) NOT NULL COMMENT '触发审核的节点',\r\n  `reviewer_id` varchar(64) NOT NULL COMMENT '审核人',\r\n  `decision` varchar(20) NOT NULL COMMENT 'APPROVE/REJECT',\r\n  `original_output` text COMMENT '修改前的原始内容(用于回溯)',\r\n  `modified_output` text COMMENT '修改后的内容',\r\n  `comment` varchar(500) COMMENT '审核意见',\r\n  `review_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,\r\n  PRIMARY KEY (`id`),\r\n  KEY `idx_execution_id` (`execution_id`),\r\n  KEY `idx_reviewer` (`reviewer_id`)\r\n) COMMENT='人工审核记录表';\r\n```\r\n\r\n### 4.3 节点配置扩展\r\n确保 `HumanReviewConfig` 生效。当节点执行完成并进入 Review 状态时，需保存当前的 Output 快照作为 `original_output`。\r\n\r\n---\r\n\r\n## 5. 技术实现建议\r\n\r\n### 5.1 Controller 层\r\n- `HumanReviewController`: 提供上述 REST 接口。\r\n\r\n### 5.2 应用服务 (`SchedulerService`)\r\n- `resumeExecution(String executionId, int version, ReviewDecision decision, ...)`\r\n    - 校验 version (乐观锁)。\r\n    - 如果 `edits` 存在，更新 `ExecutionContext` 中对应节点的 Output。\r\n    - 插入 `workflow_review_log`。\r\n    - 发布 `WorkflowResumedEvent`。\r\n\r\n- `getPendingReviewTasks(Long userId, Pageable pageable)`\r\n\r\n### 5.3 事件驱动 (SSE集成)\r\n\r\n利用现有的 `RedisSseListener` 推送状态变更：\r\n\r\n- **暂停时** (`PAUSED_FOR_REVIEW`)：\r\n  推送事件 `workflow_paused`。前端接收后显示“等待人工审核”状态条及操作按钮。\r\n  ```json\r\n  { \"executionId\": \"...\", \"nodeId\": \"...\", \"status\": \"PAUSED_FOR_REVIEW\" }\r\n  ```\r\n\r\n- **恢复时** (`RUNNING`)：\r\n  推送事件 `workflow_resumed`。前端接收后恢复加载动画。\r\n  ```json\r\n  { \"executionId\": \"...\", \"status\": \"RUNNING\" }\r\n  ```\r\n\r\n---\r\n\r\n## 6. 验收标准\r\n\r\n- [ ] 工作流在配置了审核的节点自动暂停并推送 `workflow_paused` SSE 事件。\r\n- [ ] 审核人员能通过 `/pending-review` 获取任务列表 (鉴权：Owner Only)。\r\n- [ ] 提交审核时，若版本不一致应提示冲突 (乐观锁)。\r\n- [ ] 审核通过并修改内容后，后续节点使用的是修改后的 Output。\r\n- [ ] 审核拒绝后，工作流终止。\r\n- [ ] 数据库中 `workflow_review_log` 正确记录了修改前后的内容。\r\n",
  "fileStats": {
    "size": 6075,
    "lines": 202,
    "lastModified": "2026-01-12T15:51:17.792Z"
  },
  "comments": []
}