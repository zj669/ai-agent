{
  "id": "snapshot_1768183077327_0blfzw94v",
  "approvalId": "approval_1768183077296_v795pot2f",
  "approvalTitle": "Conversation Context Tasks",
  "version": 1,
  "timestamp": "2026-01-12T01:57:57.327Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Tasks: Conversation Context Implementation\r\n\r\n- [ ] 1. Domain Layer: Define Conversation and Message Entities\r\n  - File: ai-agent-domain/src/main/java/com/zj/aiagent/domain/chat/entity/Conversation.java\r\n  - File: ai-agent-domain/src/main/java/com/zj/aiagent/domain/chat/entity/Message.java\r\n  - Implementation: Define Conversation aggregate root and Message entity with all required fields (including JSON fields for ThoughtStep, Citations).\r\n  - Define Value Objects: ThoughtStep (Recursive), Citation, MessageStatus.\r\n  - Define Repository Interface: ConversationRepository.\r\n  - _Leverage: ddd-design.md_\r\n  - _Requirements: 2.1, 2.2_\r\n  - _Prompt: Role: Java DDD Expert | Task: Implement Domain Entities and Repository Interface for Conversation Context. Ensure Checkpoint/ThoughtStep JSON compatibility structure. | Success: Entities and Repository interface defined._\r\n\r\n- [ ] 2. Infrastructure Layer: Implement Persistence\r\n  - File: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/chat/persistence/entity/ConversationDO.java\r\n  - File: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/chat/persistence/entity/MessageDO.java\r\n  - File: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/chat/repository/JpaConversationRepository.java\r\n  - File: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/chat/converter/ThoughtProcessJsonConverter.java\r\n  - Implementation: Create JPA Data Objects (DO), Repository implementation, and JSON Converters.\r\n  - Define SQL Schema (DDL) if necessary (or rely on JPA auto-ddl for dev).\r\n  - _Leverage: ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/workflow/repository/RedisCheckpointRepository.java (for reference)_\r\n  - _Requirements: 3.1_\r\n  - _Prompt: Role: Spring Data JPA Expert | Task: Implement Infrastructure persistence for Conversation and Message. Include JSON Converters for complex fields. | Success: Repository implementation ready._\r\n\r\n- [ ] 3. Application Layer: Implement ChatApplicationService\r\n  - File: ai-agent-application/src/main/java/com/zj/aiagent/application/chat/ChatApplicationService.java\r\n  - Implementation:\r\n    - `initAssistantMessage`: Create PENDING message.\r\n    - `finalizeMessage`: Update content and status.\r\n    - `appendUserMessage`: Save user input.\r\n    - `getHistory`: Retrieve messages with paging.\r\n  - _Requirements: 1.2, 1.3, 2.3_\r\n  - _Prompt: Role: Spring Service Developer | Task: Implement ChatApplicationService with streaming support (init/finalize) and history retrieval. | Success: Service business logic implemented._\r\n\r\n- [ ] 4. Application Layer: Event Listeners\r\n  - File: ai-agent-application/src/main/java/com/zj/aiagent/application/chat/listener/ExecutionCompletedListener.java\r\n  - File: ai-agent-application/src/main/java/com/zj/aiagent/application/chat/listener/AutoTitleListener.java\r\n  - Implementation:\r\n    - Listen to `ExecutionCompletedEvent` to finalize Assistant message.\r\n    - Logic for Auto-generating title (stub or call LLM service).\r\n  - _Requirements: 4.1_\r\n  - _Prompt: Role: Spring Event Specialist | Task: Implement Event Listeners for bridging Workflow execution and Conversation records. | Success: Listeners correctly trigger Service methods._\r\n\r\n- [ ] 5. Interface Layer: Implement ChatController\r\n  - File: ai-agent-interfaces/src/main/java/com/zj/aiagent/interfaces/chat/ChatController.java\r\n  - Implementation: REST APIs for Conversation CRUD and History.\r\n  - _Requirements: 1.2_\r\n  - _Prompt: Role: API Developer | Task: Implement ChatController endpoints exposing Application Service methods. | Success: API endpoints verifiable via HTTP._\r\n\r\n- [ ] 6. Verification\r\n  - Verification Strategy: Use `curl` or unit tests to simulate:\r\n    1. Create Conversation.\r\n    2. User sends message (`appendUserMessage`).\r\n    3. Simulate Workflow execution (Init -> Finalize).\r\n    4. Verify Message content (JSON ThoughtProcess).\r\n    5. Verify Auto-Title trigger.\r\n",
  "fileStats": {
    "size": 3989,
    "lines": 56,
    "lastModified": "2026-01-12T01:57:48.968Z"
  },
  "comments": []
}