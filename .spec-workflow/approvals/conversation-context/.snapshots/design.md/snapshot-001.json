{
  "id": "snapshot_1768182661922_54bztpvog",
  "approvalId": "approval_1768182661907_xd7n0zirj",
  "approvalTitle": "Conversation Context Design",
  "version": 1,
  "timestamp": "2026-01-12T01:51:01.922Z",
  "trigger": "initial",
  "status": "pending",
  "content": "# Design Document - Conversation Context Service\r\n\r\n## Overview\r\n\r\nConversation Context 模块负责管理用户与 AI Agent 之间的所有交互历史。它处于架构的支撑域位置，向下对接数据库存储，向上为 Workflow 提供上下文，向外提供 RESTful API 供前端调用。本设计引入了富文本消息结构（思维链、引用、Artifacts），支持高保真 UI 展示。\r\n\r\n## Steering Document Alignment\r\n\r\n### Technical Standards (ddd-design.md)\r\n- **Domain-Driven Design**:\r\n    - 聚合根：`Conversation`\r\n    - 实体：`Message`\r\n    - 值对象：`ThoughtStep`, `Citation`, `ArtifactReference`, `MessageStatus`\r\n- **Layered Architecture**: 严格遵循 Interface -> Application -> Domain -> Infrastructure 分层。\r\n- **Decoupling**: 通过 Domain Events (`ExecutionCompletedEvent`) 异步解耦消息写入。\r\n\r\n### Project Structure (structure.md)\r\n- 代码位置：\r\n    - `ai-agent-domain/src/main/java/com/zj/aiagent/domain/chat`: 领域对象\r\n    - `ai-agent-infrastructure/src/main/java/com/zj/aiagent/infrastructure/chat`: 仓储实现\r\n    - `ai-agent-application/src/main/java/com/zj/aiagent/application/chat`: 应用服务\r\n    - `ai-agent-interfaces/src/main/java/com/zj/aiagent/interfaces/chat`: 控制器\r\n\r\n## Code Reuse Analysis\r\n\r\n### Existing Components to Leverage\r\n- **Shared Utils**: `Response`, `PageResult` 用于 API 响应标准化。\r\n- **Event Bus**: 利用现有的 Spring Event 机制监听 `ExecutionCompletedEvent`。\r\n- **User Context**: 复用 `UserContext` 获取当前登录用户 ID。\r\n\r\n### Integration Points\r\n- **Execution Module**: 监听 `Execution` 完成事件，自动记录 ASSISTANT 消息。\r\n- **Database**: 新增 `conversations` 和 `messages` 表（或 Mongo 集合），建议 MVP 阶段使用 MySQL 存储 JSON 字段 (ThoughtProcess)。\r\n\r\n## Architecture\r\n\r\n```mermaid\r\ngraph TD\r\n    API[ChatController] --> AppService[ChatApplicationService]\r\n    AppService --> Repo[ConversationRepository]\r\n    AppService --> ExecutionService[ExecutionApplicationService]\r\n    \r\n    Workflow[WorkflowEngine] --Event--> Listener[ConversationEventListener]\r\n    Listener --> AppService\r\n    \r\n    Repo --Persistence--> DB[(Database)]\r\n```\r\n\r\n## Components and Interfaces\r\n\r\n### 1. ChatApplicationService (Application Layer)\r\n- **Purpose**: 协调会话管理和消息记录。\r\n- **Interfaces**:\r\n    - `createConversation(userId, agentId)`\r\n    - `getConversationHistory(conversationId, page, size)`\r\n    - `appendUserMessage(conversationId, content)`\r\n    - `appendAssistantMessage(conversationId, executionResult)`\r\n    - `deleteConversation(conversationId)`\r\n- **Dependencies**: `ConversationRepository`, `TransactionTemplate`\r\n\r\n### 2. ConversationRepository (Domain Interface)\r\n- **Purpose**: 提供领域对象的持久化接口。\r\n- **Interfaces**:\r\n    - `save(Conversation)`\r\n    - `findById(id)`\r\n    - `findByUserIdAndAgentId(conversationId, pageable)`\r\n    - `saveMessage(Message)`\r\n    - `findMessages(conversationId)`\r\n\r\n## Data Models\r\n\r\n### Domain Model: Conversation (Aggregate Root)\r\n```java\r\npublic class Conversation {\r\n    private String id;\r\n    private String userId;\r\n    private String agentId;\r\n    private String title;\r\n    private LocalDateTime createdAt;\r\n    private LocalDateTime updatedAt;\r\n    \r\n    // Business Methods\r\n    public void updateTitle(String newTitle);\r\n    public void markUpdated();\r\n}\r\n```\r\n\r\n### Domain Model: Message (Entity)\r\n```java\r\npublic class Message {\r\n    private String id;\r\n    private String conversationId;\r\n    private MessageRole role; // USER, ASSISTANT\r\n    private String content;   // Markdown\r\n    \r\n    // Rich Features (Stored as JSON)\r\n    private List<ThoughtStep> thoughtProcess;\r\n    private List<Citation> citations;\r\n    private List<String> artifactIds;\r\n    \r\n    private MessageStatus status; // COMPLETED, FAILED\r\n    private String runId;        // Workflow Execution ID\r\n    private Integer tokenCount;\r\n    private LocalDateTime createdAt;\r\n}\r\n```\r\n\r\n### Value Objects\r\n- **ThoughtStep**: `{ title, content, durationMs, toolCalls: [] }`\r\n- **Citation**: `{ sourceUrl, sourceName, snippet, pageIndex }`\r\n- **MessageStatus**: `PENDING`, `STREAMING`, `COMPLETED`, `FAILED`, `CANCELLED`\r\n\r\n## Database Schema (MySQL)\r\n\r\n**Table: conversations**\r\n| Column | Type | Notes |\r\n|---|---|---|\r\n| id | VARCHAR(64) | PK |\r\n| user_id | VARCHAR(64) | IDX |\r\n| agent_id | VARCHAR(64) | |\r\n| title | VARCHAR(255) | |\r\n| created_at | DATETIME | |\r\n| updated_at | DATETIME | IDX (Sort) |\r\n| is_deleted | TINYINT | Logic Delete |\r\n\r\n**Table: messages**\r\n| Column | Type | Notes |\r\n|---|---|---|\r\n| id | VARCHAR(64) | PK |\r\n| conversation_id | VARCHAR(64) | IDX |\r\n| role | VARCHAR(20) | |\r\n| content | LONGTEXT | |\r\n| thought_process | JSON | Structured steps |\r\n| citations | JSON | References |\r\n| meta_data | JSON | token_count, artifacts, run_id |\r\n| status | VARCHAR(20) | |\r\n| created_at | DATETIME | IDX (Sort) |\r\n\r\n## Implementation Steps\r\n\r\n1.  **Domain Layer**: 定义 `Conversation`, `Message` 及相关 VO。定义 `ConversationRepository` 接口。\r\n2.  **Infrastructure Layer**: 实现 `JpaConversationRepository` (Spring Data JPA) 和 DO 对象。\r\n3.  **Application Layer**: 实现 `ChatApplicationService`，特别是消息追加（JSON处理）和事件监听器。\r\n4.  **Interface Layer**: 实现 `ChatController`。\r\n5.  **Integration**: 绑定 `ExecutionCompletedEvent` 自动写入 Assistant 消息。\r\n\r\n## Error Handling\r\n\r\n1.  **Concurrent Writes**: 虽然会话通常单线程，但若出现并发写入，使用数据库事务保证 `updated_at` 和消息顺序。\r\n2.  **Large JSON Persistence**: `thought_process` 可能很大，确保数据库列类型为 `LONGTEXT` 或 `JSON` (MySQL 5.7+)。\r\n\r\n## Testing Strategy\r\n\r\n- **Unit Testing**: 测试 `Conversation` 聚合根的业务逻辑（如标题更新）。\r\n- **Integration Testing**: 测试 `ChatApplicationService` 与 H2/MySQL 的交互，验证 JSON 序列化/反序列化。\r\n- **Scenario Testing**: 模拟完整流程：创建会话 -> 用户发消息 -> 工作流执行 -> 自动记录 Assistant 消息 -> 查询历史。\r\n",
  "fileStats": {
    "size": 6174,
    "lines": 157,
    "lastModified": "2026-01-12T01:50:52.051Z"
  },
  "comments": []
}