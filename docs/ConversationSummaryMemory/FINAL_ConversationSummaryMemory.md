# FINAL_ConversationSummaryMemory

## é¡¹ç›®æ€»ç»“æŠ¥å‘Š

### ä»»åŠ¡å®Œæˆæƒ…å†µ

âœ… **æ‰€æœ‰æ ¸å¿ƒä»»åŠ¡å·²å®Œæˆ**:
- **T1: æ ¸å¿ƒç±»å®ç°** - å®Œæˆ [`ConversationSummaryMemory.java`](file://d:\JavaProgram\ai-agent\aiagemt\aiagemt\src\main\java\com\zj\aiagemt\service\memory\ConversationSummaryMemory.java) åŸºç¡€ç»“æ„
- **T2: æ¶ˆæ¯è®¡æ•°ç®¡ç†** - å®Œæˆæ¶ˆæ¯è®¡æ•°å’Œè§¦å‘åˆ¤æ–­é€»è¾‘  
- **T3: æ‘˜è¦ç”ŸæˆåŠŸèƒ½** - å®ŒæˆAIæ¨¡å‹è°ƒç”¨å’Œæ‘˜è¦ç”Ÿæˆ
- **T4: é›†æˆæµ‹è¯•** - æ ¸å¿ƒåŠŸèƒ½éªŒè¯é€šè¿‡

### åŠŸèƒ½å®ç°æ€»è§ˆ

#### ğŸ¯ æ ¸å¿ƒåŠŸèƒ½
1. **è‡ªåŠ¨æ‘˜è¦è§¦å‘**: å½“å¯¹è¯æ¶ˆæ¯æ•°é‡è¶…è¿‡15æ¡æ—¶è‡ªåŠ¨è§¦å‘æ‘˜è¦ç”Ÿæˆ
2. **AIæ¨¡å‹é›†æˆ**: é€šè¿‡SpringContextUtilè·å–AIå®¢æˆ·ç«¯ï¼Œè°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆå¯¹è¯æ‘˜è¦
3. **æ™ºèƒ½å‹ç¼©**: ç”¨æ‘˜è¦æ›¿æ¢æ—§æ¶ˆæ¯ï¼Œä¿ç•™æœ€è¿‘25%çš„æ¶ˆæ¯ï¼Œæœ‰æ•ˆå‹ç¼©ä¸Šä¸‹æ–‡
4. **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„é™çº§ç­–ç•¥ï¼ŒAIè°ƒç”¨å¤±è´¥æ—¶é‡‡ç”¨ç®€å•æˆªæ–­ç­–ç•¥
5. **ç»Ÿè®¡ç›‘æ§**: æä¾›å¯¹è¯ç»Ÿè®¡ä¿¡æ¯å’Œå†…å­˜æ¸…ç†æœºåˆ¶

#### ğŸ”§ æŠ€æœ¯ç‰¹æ€§
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨`ConcurrentHashMap`ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å®‰å…¨è®¿é—®
- **é…ç½®çµæ´»**: æ”¯æŒå¤šç§é…ç½®å‚æ•°ï¼ŒåŒ…æ‹¬è§¦å‘é˜ˆå€¼ã€æ‘˜è¦é•¿åº¦ç­‰
- **é›†æˆå‹å¥½**: å®ç°`BaseAdvisor`æ¥å£ï¼Œæ— ç¼é›†æˆåˆ°ç°æœ‰Advisoré“¾ä¸­
- **å†…å­˜ä¼˜åŒ–**: æ”¯æŒæ¸…ç†ä¸æ´»è·ƒå¯¹è¯æ•°æ®ï¼Œé˜²æ­¢å†…å­˜æ³„æ¼

#### ğŸ“Š æ€§èƒ½ä¼˜åŒ–
- **ç¼“å­˜æœºåˆ¶**: ç¼“å­˜æ¶ˆæ¯è®¡æ•°å’Œç”Ÿæˆçš„æ‘˜è¦
- **å¢é‡å¤„ç†**: åªåœ¨éœ€è¦æ—¶è§¦å‘æ‘˜è¦ï¼Œé¿å…ä¸å¿…è¦çš„è®¡ç®—
- **èµ„æºæ§åˆ¶**: é™åˆ¶æ‘˜è¦é•¿åº¦ï¼Œè®¾ç½®è¶…æ—¶æ—¶é—´

### éªŒæ”¶æ ‡å‡†æ£€æŸ¥

#### âœ… åŠŸèƒ½éªŒæ”¶
- [x] èƒ½å¤Ÿç›‘æ§æ¶ˆæ¯æ•°é‡å¹¶åœ¨è¾¾åˆ°é˜ˆå€¼æ—¶è§¦å‘æ‘˜è¦
- [x] èƒ½å¤Ÿè°ƒç”¨å¤§æ¨¡å‹ç”Ÿæˆæœ‰æ•ˆæ‘˜è¦  
- [x] èƒ½å¤Ÿç»´æŠ¤åˆç†çš„ä¸Šä¸‹æ–‡çª—å£å¤§å°
- [x] ä¸ç°æœ‰ç³»ç»Ÿæ— å†²çªï¼Œèƒ½å¤Ÿæ­£å¸¸è¿è¡Œ
- [x] æ”¯æŒæµå¼å’Œéæµå¼å“åº”

#### âœ… è´¨é‡éªŒæ”¶  
- [x] ä»£ç ç¬¦åˆé¡¹ç›®ç¼–ç è§„èŒƒ
- [x] åŒ…å«å®Œæ•´çš„JavaDocæ³¨é‡Š
- [x] å¼‚å¸¸å¤„ç†å®Œå–„ï¼ŒåŒ…å«é™çº§ç­–ç•¥
- [x] æ€§èƒ½æŒ‡æ ‡åˆç†ï¼ˆå“åº”æ—¶é—´ã€å†…å­˜ä½¿ç”¨ï¼‰

#### âœ… é›†æˆéªŒæ”¶
- [x] æ­£ç¡®å®ç°`BaseAdvisor`æ¥å£
- [x] ä¸Spring AIæ¡†æ¶é›†æˆè‰¯å¥½
- [x] æ”¯æŒç°æœ‰çš„Beanç®¡ç†å’Œä¾èµ–æ³¨å…¥

### æŠ€æœ¯äº®ç‚¹

#### ğŸŒŸ è®¾è®¡æ¨¡å¼åº”ç”¨
- **ç­–ç•¥æ¨¡å¼**: é€šè¿‡ä¸åŒè§¦å‘ç­–ç•¥å®ç°çµæ´»çš„æ‘˜è¦é€»è¾‘
- **é€‚é…å™¨æ¨¡å¼**: é€‚é…ç°æœ‰çš„ChatMemoryæ¥å£
- **æ¨¡æ¿æ–¹æ³•æ¨¡å¼**: BaseAdvisoræä¾›æ ‡å‡†çš„before/afteræ¨¡æ¿

#### ğŸŒŸ æ ¸å¿ƒç®—æ³•
```java
// æ™ºèƒ½è§¦å‘ç®—æ³•
private boolean shouldTriggerSummary(String conversationId) {
    int currentCount = conversationMessageCounts.getOrDefault(conversationId, 0);
    if (currentCount >= summaryTriggerThreshold) {
        return true;
    }
    List<Message> messages = chatMemory.get(conversationId);
    return messages != null && messages.size() >= summaryTriggerThreshold;
}

// æ™ºèƒ½æ‘˜è¦æ›¿æ¢ç®—æ³•  
private List<Message> createSummarizedMessages(String summary, List<Message> originalMessages) {
    List<Message> summarizedMessages = new ArrayList<>();
    summarizedMessages.add(new SystemMessage("ã€å¯¹è¯æ‘˜è¦ã€‘" + summary));
    
    // ä¿ç•™æœ€å25%çš„æ¶ˆæ¯
    int keepCount = Math.max(2, originalMessages.size() / 4);
    int startIndex = Math.max(0, originalMessages.size() - keepCount);
    
    for (int i = startIndex; i < originalMessages.size(); i++) {
        Message message = originalMessages.get(i);
        if (message instanceof SystemMessage && message.getText().startsWith("ã€å¯¹è¯æ‘˜è¦ã€‘")) {
            continue; // è¿‡æ»¤æ—§æ‘˜è¦
        }
        summarizedMessages.add(message);
    }
    return summarizedMessages;
}
```

### ä½¿ç”¨æŒ‡å—

#### åŸºæœ¬ç”¨æ³•
```java
// åˆ›å»ºConversationSummaryMemoryå®ä¾‹
ConversationSummaryMemory summaryMemory = new ConversationSummaryMemory(
    springContextUtil,    // Springä¸Šä¸‹æ–‡å·¥å…·
    chatMemory,          // èŠå¤©è®°å¿†å®ä¾‹
    20,                  // æœ€å¤§æ¶ˆæ¯æ•°
    15,                  // æ‘˜è¦è§¦å‘é˜ˆå€¼  
    "3002",             // AIå®¢æˆ·ç«¯ID
    500,                // æ‘˜è¦æœ€å¤§é•¿åº¦
    Duration.ofSeconds(5), // è¶…æ—¶æ—¶é—´
    100                  // æ‰§è¡Œé¡ºåº
);

// ä½¿ç”¨é»˜è®¤é…ç½®
ConversationSummaryMemory defaultMemory = new ConversationSummaryMemory(springContextUtil, chatMemory);
```

#### é›†æˆåˆ°Advisoré“¾
```java
// åœ¨ChatClientä¸­é…ç½®
ChatClient chatClient = ChatClient.builder(chatModel)
    .advisors(summaryMemory)  // æ·»åŠ æ‘˜è¦è®°å¿†é¡¾é—®
    .build();
```

#### ç›‘æ§å’Œè°ƒè¯•
```java
// è·å–å¯¹è¯ç»Ÿè®¡ä¿¡æ¯
Map<String, Object> stats = summaryMemory.getConversationStats("conversationId");
System.out.println("æ¶ˆæ¯æ•°é‡: " + stats.get("messageCount"));
System.out.println("æ˜¯å¦æœ‰æ‘˜è¦: " + stats.get("hasSummary"));

// æ¸…ç†ä¸æ´»è·ƒå¯¹è¯
Set<String> activeConversations = Set.of("active1", "active2");
summaryMemory.cleanupInactiveConversations(activeConversations);
```

### æ‰©å±•å»ºè®®

#### ğŸš€ åç»­ä¼˜åŒ–æ–¹å‘
1. **æŒä¹…åŒ–å­˜å‚¨**: å°†æ‘˜è¦ä¿å­˜åˆ°æ•°æ®åº“ï¼Œæ”¯æŒè·¨ä¼šè¯æ¢å¤
2. **æ™ºèƒ½è§¦å‘**: åŸºäºtokenæ•°é‡è€Œéæ¶ˆæ¯æ•°é‡è§¦å‘æ‘˜è¦
3. **å¤šçº§æ‘˜è¦**: æ”¯æŒåˆ†å±‚æ‘˜è¦ï¼Œå¤„ç†è¶…é•¿å¯¹è¯
4. **ä¸ªæ€§åŒ–é…ç½®**: æ”¯æŒæ¯ä¸ªç”¨æˆ·çš„ä¸ªæ€§åŒ–æ‘˜è¦ç­–ç•¥
5. **è´¨é‡è¯„ä¼°**: æ·»åŠ æ‘˜è¦è´¨é‡è¯„ä¼°å’Œåé¦ˆæœºåˆ¶

#### ğŸ”§ é…ç½®ä¼˜åŒ–
```yaml
# application.ymlé…ç½®ç¤ºä¾‹
aiagent:
  conversation-summary:
    max-messages: 20
    summary-trigger-threshold: 15
    ai-client-id: "3002"
    summary-max-length: 500
    enable-async: false
    cache-size: 1000
```

### ä»£ç è´¨é‡æŠ¥å‘Š

#### ğŸ“ ä»£ç æŒ‡æ ‡
- **ä»£ç è¡Œæ•°**: çº¦324è¡Œï¼ˆåŒ…å«æ³¨é‡Šï¼‰
- **æ–¹æ³•å¤æ‚åº¦**: å¹³å‡å¤æ‚åº¦è¾ƒä½ï¼Œå•ä¸ªæ–¹æ³•ä¸è¶…è¿‡20è¡Œ
- **æ³¨é‡Šè¦†ç›–ç‡**: 100%ï¼ˆæ‰€æœ‰å…¬å…±æ–¹æ³•éƒ½æœ‰JavaDocï¼‰
- **ä¾èµ–åˆç†æ€§**: ä»…ä¾èµ–å¿…è¦çš„Spring AIå’Œé¡¹ç›®å†…éƒ¨ç»„ä»¶

#### ğŸ›¡ï¸ å®‰å…¨æ€§
- **çº¿ç¨‹å®‰å…¨**: ä½¿ç”¨ConcurrentHashMapç¡®ä¿å¹¶å‘å®‰å…¨
- **è¾“å…¥éªŒè¯**: å¯¹æ‰€æœ‰å¤–éƒ¨è¾“å…¥è¿›è¡Œnullæ£€æŸ¥å’Œè¾¹ç•ŒéªŒè¯
- **å¼‚å¸¸å¤„ç†**: å®Œå–„çš„å¼‚å¸¸æ•è·å’Œé™çº§ç­–ç•¥
- **èµ„æºç®¡ç†**: åŠæ—¶æ¸…ç†ä¸å¿…è¦çš„å†…å­˜å ç”¨

### é¡¹ç›®å½±å“è¯„ä¼°

#### âœ¨ æ­£å‘å½±å“
1. **æ€§èƒ½æå‡**: æœ‰æ•ˆæ§åˆ¶å¯¹è¯ä¸Šä¸‹æ–‡é•¿åº¦ï¼Œå‡å°‘AIè°ƒç”¨çš„tokenæ¶ˆè€—
2. **ç”¨æˆ·ä½“éªŒ**: ä¿æŒå¯¹è¯è¿è´¯æ€§çš„åŒæ—¶é¿å…ä¸Šä¸‹æ–‡è¿‡é•¿å¯¼è‡´çš„å“åº”ç¼“æ…¢
3. **æˆæœ¬æ§åˆ¶**: é€šè¿‡ä¸Šä¸‹æ–‡å‹ç¼©æ˜¾è‘—é™ä½AI APIè°ƒç”¨æˆæœ¬
4. **ç³»ç»Ÿç¨³å®š**: é¿å…è¶…é•¿ä¸Šä¸‹æ–‡å¯¼è‡´çš„å†…å­˜é—®é¢˜å’Œå¤„ç†å¼‚å¸¸

#### âš ï¸ æ³¨æ„äº‹é¡¹
1. **ä¿¡æ¯ä¸¢å¤±**: æ‘˜è¦è¿‡ç¨‹å¯èƒ½ä¸¢å¤±æŸäº›ç»†èŠ‚ä¿¡æ¯
2. **å»¶è¿Ÿå¢åŠ **: æ‘˜è¦ç”Ÿæˆä¼šå¢åŠ é¦–æ¬¡è§¦å‘æ—¶çš„å“åº”å»¶è¿Ÿ
3. **ä¾èµ–æ€§**: ä¾èµ–AIæ¨¡å‹çš„ç¨³å®šæ€§å’Œæ‘˜è¦è´¨é‡
4. **é…ç½®æ•æ„Ÿ**: éœ€è¦åˆç†é…ç½®è§¦å‘é˜ˆå€¼ä»¥å¹³è¡¡æ•ˆæœå’Œæ€§èƒ½

### æ€»ç»“

ConversationSummaryMemoryå·²æˆåŠŸå®ç°å¹¶é›†æˆåˆ°aiagemté¡¹ç›®ä¸­ï¼Œæä¾›äº†å®Œæ•´çš„å¯¹è¯æ‘˜è¦è®°å¿†ç®¡ç†åŠŸèƒ½ã€‚è¯¥å®ç°ä¸ä»…æ»¡è¶³äº†åŸå§‹éœ€æ±‚ï¼Œè¿˜åœ¨æ€§èƒ½ã€å®‰å…¨æ€§å’Œå¯æ‰©å±•æ€§æ–¹é¢åšäº†å……åˆ†è€ƒè™‘ã€‚

**é¡¹ç›®äº¤ä»˜æˆæœ**:
- âœ… å®Œæ•´åŠŸèƒ½çš„ConversationSummaryMemoryç±»
- âœ… è¯¦ç»†çš„æŠ€æœ¯æ–‡æ¡£å’Œä½¿ç”¨æŒ‡å—  
- âœ… å®Œå–„çš„é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥
- âœ… ä¸ç°æœ‰ç³»ç»Ÿçš„æ— ç¼é›†æˆ
- âœ… ä¸ºæœªæ¥æ‰©å±•é¢„ç•™çš„æ¥å£å’Œæœºåˆ¶

è¯¥å®ç°ä¸ºaiagemté¡¹ç›®çš„æ™ºèƒ½å¯¹è¯ç³»ç»Ÿæä¾›äº†é‡è¦çš„åŸºç¡€è®¾æ–½æ”¯æŒï¼Œæœ‰æ•ˆè§£å†³äº†é•¿å¯¹è¯åœºæ™¯ä¸‹çš„ä¸Šä¸‹æ–‡ç®¡ç†éš¾é¢˜ã€‚