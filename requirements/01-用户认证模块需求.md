# AI-Agent 用户认证模块需求文档

## 1. 模块概述

### 1.1 模块名称
用户认证模块（Identity Context）

### 1.2 模块定位
通用域（Generic Domain）- 提供用户身份认证、会话管理等通用能力

### 1.3 核心价值
- 保障平台安全，防止未授权访问
- 提供无感知的登录体验
- 支持多维度安全防护（邮箱验证、限流控制）

---

## 2. 功能需求

### 2.1 邮箱验证码发送

**功能描述**：用户注册前，系统向指定邮箱发送6位数字验证码。

**业务规则**：
| 规则项 | 描述 |
|--------|------|
| 验证码有效期 | 5分钟 |
| 邮箱限流 | 同一邮箱1分钟内最多1次 |
| IP限流 | 同一IP 1小时内最多10次 |
| 设备限流 | 同一设备1小时内最多5次 |

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | String | 是 | 用户邮箱地址 |
| deviceId | String | 否 | 设备标识符 |

**输出**：成功/失败状态

**接口路径**：`POST /client/user/email/sendCode`

---

### 2.2 邮箱注册

**功能描述**：用户通过邮箱验证码完成账号注册。

**业务规则**：
- 验证验证码有效性
- 邮箱唯一性校验
- 密码强度要求（待定，当前无强制要求）
- 注册成功后自动生成 Token 并返回

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | String | 是 | 用户邮箱 |
| code | String | 是 | 验证码 |
| password | String | 是 | 密码 |
| username | String | 否 | 用户名 |
| deviceId | String | 否 | 设备标识 |

**输出**：用户信息 + Token

**接口路径**：`POST /client/user/email/register`

---

### 2.3 用户登录

**功能描述**：已注册用户通过邮箱/密码登录系统。

**业务规则**：
- 验证账号密码匹配
- 记录登录IP和时间
- 生成 JWT Token 返回客户端

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| email | String | 是 | 登录账号（邮箱） |
| password | String | 是 | 密码 |

**输出**：用户信息 + Token

**接口路径**：`POST /client/user/login`

---

### 2.4 获取用户信息

**功能描述**：获取当前登录用户的基本信息。

**业务规则**：
- 需要携带有效 Token
- Token 无效返回 401 错误

**输入参数**：无（从 Token 解析用户ID）

**输出**：
| 字段 | 类型 | 说明 |
|------|------|------|
| id | Long | 用户ID |
| username | String | 用户名 |
| email | String | 邮箱 |
| phone | String | 手机号 |

**接口路径**：`GET /client/user/info`

---

### 2.5 用户登出

**功能描述**：用户退出登录，使当前 Token 失效。

**业务规则**：
- Token 加入黑名单
- 后续携带该 Token 的请求拒绝访问

**输入参数**：Token（从请求头 Authorization 获取）

**输出**：成功/失败状态

**接口路径**：`POST /client/user/logout`

---

## 3. 非功能需求

### 3.1 安全性
- 密码存储使用加密（BCrypt）
- Token 使用 JWT 签名，支持过期时间
- 敏感操作（注册、登录）记录审计日志

### 3.2 可用性
- 验证码发送失败支持重试
- 登录失败返回友好错误提示

### 3.3 性能
- 限流检查使用 Redis 实现，响应时间 < 50ms
- Token 校验响应时间 < 10ms

---

## 4. 领域模型

### 4.1 聚合根：User

```java
User {
    id: Long              // 用户ID
    username: String      // 用户名
    email: String         // 邮箱（唯一）
    phone: String         // 手机号
    credential: Credential // 密码凭证
    status: UserStatus    // 用户状态
    lastLoginIp: String   // 最后登录IP
    lastLoginTime: DateTime // 最后登录时间
}
```

### 4.2 值对象

| 值对象 | 属性 | 说明 |
|--------|------|------|
| Email | value: String | 封装邮箱格式验证 |
| Credential | encryptedPassword: String | 封装密码加密逻辑 |

### 4.3 领域服务

| 服务 | 职责 |
|------|------|
| UserAuthenticationDomainService | 执行注册、登录的核心业务逻辑 |
| EmailVerificationDomainService | 验证码生成与校验 |
| RateLimitDomainService | 限流策略执行 |

---

## 5. 依赖关系

### 5.1 对外提供
- TokenService：Token 生成与校验
- UserContext：当前登录用户上下文

### 5.2 依赖外部
- Redis：Token 存储、限流计数
- 邮件服务：发送验证码邮件
