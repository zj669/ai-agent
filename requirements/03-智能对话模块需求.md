# AI-Agent 智能对话模块需求文档

## 1. 模块概述

### 1.1 模块名称
智能对话模块（Conversation Context）

### 1.2 模块定位
支撑域（Supporting Domain）- 管理用户与 Agent 的对话交互

### 1.3 核心价值
- 提供实时流式对话体验（SSE）
- 维护对话历史记录
- 支持多轮会话上下文

---

## 2. 功能需求

### 2.1 发起对话

**功能描述**：用户向指定 Agent 发送消息，触发工作流执行，并通过 SSE 实时推送执行结果。

**业务规则**：
- Agent 必须处于已发布状态
- 自动创建或复用会话（conversationId）
- 通过 SSE (Server-Sent Events) 流式返回执行过程
- 每个节点的执行状态和输出实时推送

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| agentId | String | 是 | Agent ID |
| conversationId | String | 否 | 会话ID（续对话时传入） |
| message | String | 是 | 用户消息内容 |

**输出**：SSE 事件流

**SSE 事件类型**：
| 事件类型 | 说明 | 数据结构 |
|----------|------|----------|
| dag_start | 工作流开始 | {dagId, conversationId} |
| node_lifecycle | 节点生命周期 | {nodeId, nodeName, status, content} |
| dag_complete | 工作流完成 | {success, message} |
| error | 错误事件 | {errorMessage} |

**接口路径**：`POST /client/chat/agent` (Content-Type: text/event-stream)

---

### 2.2 创建新对话

**功能描述**：为用户创建一个新的会话ID。

**业务规则**：
- 生成全局唯一的 conversationId
- 返回新会话ID供后续对话使用

**输入参数**：无

**输出**：
| 字段 | 类型 | 说明 |
|------|------|------|
| conversationId | String | 新的会话ID |

**接口路径**：`GET /client/chat/new`

---

### 2.3 获取历史会话ID

**功能描述**：获取用户与指定 Agent 的最近一次会话ID。

**业务规则**：
- 查询用户与该 Agent 的最后一个会话
- 用于"继续对话"场景

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| agentId | String | 是 | Agent ID |

**输出**：
| 字段 | 类型 | 说明 |
|------|------|------|
| conversationId | String | 会话ID（可能为空） |

**接口路径**：`GET /client/chat/{agentId}/old`

---

### 2.4 查询对话历史

**功能描述**：获取指定会话的完整消息历史，包含每条消息中各节点的执行记录。

**业务规则**：
- 返回按时间正序排列的消息列表
- 每条消息包含角色（USER/ASSISTANT）和内容
- ASSISTANT 消息包含节点执行详情

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| agentId | String | 是 | Agent ID |
| conversationId | String | 是 | 会话ID |

**输出**：
```json
[
  {
    "id": "msg-001",
    "role": "USER",
    "content": "帮我分析这个数据",
    "timestamp": "2025-01-10T10:30:00"
  },
  {
    "id": "msg-002",
    "role": "ASSISTANT",
    "content": "分析完成，结果如下...",
    "timestamp": "2025-01-10T10:30:05",
    "nodeExecutions": [
      {
        "nodeId": "llm-1",
        "nodeName": "数据分析",
        "status": "COMPLETED",
        "content": "...",
        "startTime": 1704866400000,
        "endTime": 1704866405000,
        "error": null
      }
    ]
  }
]
```

**接口路径**：`GET /client/chat/{agentId}/history/{conversationId}`

---

### 2.5 取消执行

**功能描述**：取消正在执行中的工作流。

**业务规则**：
- 向调度器发送取消信号
- 正在执行的节点会被中断
- 发送取消完成的 SSE 事件

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | String | 是 | 会话ID |

**输出**：成功/失败状态

**接口路径**：`POST /client/chat/cancel`

---

## 3. SSE 事件详细定义

### 3.1 dag_start 事件
```
event: dag_start
data: {"dagId":"dag-xxx","conversationId":"conv-xxx"}
```

### 3.2 node_lifecycle 事件

**节点开始**：
```
event: node_lifecycle
data: {"nodeId":"llm-1","nodeName":"分析节点","status":"starting"}
```

**节点流式输出**（LLM 节点）：
```
event: node_lifecycle
data: {"nodeId":"llm-1","status":"streaming","content":"正在分析..."}
```

**节点暂停**（人工介入节点）：
```
event: node_lifecycle
data: {"nodeId":"human-1","nodeName":"人工审核","status":"paused"}
```

**节点完成**：
```
event: node_lifecycle
data: {"nodeId":"llm-1","status":"completed","durationMs":2500}
```

### 3.3 dag_complete 事件
```
event: dag_complete
data: {"success":true,"message":"工作流执行完成"}
```

### 3.4 error 事件
```
event: error
data: {"errorMessage":"节点执行失败: API调用超时"}
```

---

## 4. 非功能需求

### 4.1 实时性
- SSE 事件推送延迟 < 100ms
- LLM 流式输出 token 实时推送

### 4.2 可靠性
- SSE 连接断开后支持重连
- 执行过程中断支持从检查点恢复

### 4.3 性能
- 单个 Agent 支持并发会话数 > 100
- 历史消息查询响应时间 < 200ms

---

## 5. 领域模型

### 5.1 聚合根：Conversation

```java
Conversation {
    id: ConversationId     // 会话ID
    agentId: AgentId       // 关联的 Agent
    userId: UserId         // 用户ID
    messages: List<Message> // 消息列表
    createdAt: DateTime    // 创建时间
    
    // 领域行为
    addMessage(message)    // 添加消息
    getHistory(limit)      // 获取历史
}
```

### 5.2 实体：Message

```java
Message {
    id: MessageId
    role: MessageRole       // USER, ASSISTANT, SYSTEM
    content: String
    timestamp: DateTime
    nodeExecutions: List<NodeExecutionRecord>
}
```

### 5.3 值对象：NodeExecutionRecord

```java
NodeExecutionRecord {
    nodeId: String
    nodeName: String
    status: String
    content: String
    startTime: Long
    endTime: Long
    error: String
}
```

---

## 6. 依赖关系

### 6.1 对外提供
- 对话历史查询接口
- SSE 事件订阅能力

### 6.2 依赖外部
- 工作流编排模块：执行工作流
- Agent 管理模块：获取 Agent 配置
- 用户认证模块：身份验证
