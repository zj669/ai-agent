# AI-Agent 库表设计文档

本文档详细描述 AI-Agent 系统的数据库表结构设计，包含字段说明和完整的 SQL 建表语句。

---

## 一、用户认证模块（Identity Context）

### 1. `user_info` (用户信息表)

**作用**：存储用户账号基础信息，支持邮箱注册、密码登录。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 用户ID，主键 |
| username | VARCHAR(50) | NOT NULL | - | 用户名，用于展示 |
| email | VARCHAR(100) | UNIQUE, NOT NULL | - | 邮箱地址，登录账号，唯一约束 |
| password | VARCHAR(255) | NOT NULL | - | BCrypt 加密后的密码哈希 |
| phone | VARCHAR(20) | NULL | NULL | 手机号（可选） |
| avatar_url | VARCHAR(500) | NULL | NULL | 用户头像URL |
| status | TINYINT | NOT NULL | 1 | 用户状态：0-禁用，1-正常 |
| last_login_ip | VARCHAR(50) | NULL | NULL | 最后登录IP地址 |
| last_login_time | DATETIME | NULL | NULL | 最后登录时间 |
| deleted | TINYINT | NOT NULL | 0 | 逻辑删除：0-正常，1-已删除 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间（ON UPDATE 自动更新） |

---

## 二、Agent 管理模块（设计态）

### 2. `agent_info` (Agent 信息主表)

**作用**：存储 Agent 的基础信息以及**草稿状态**的工作流定义。用户在画布上编辑但未发布的数据存这里。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | Agent ID，主键 |
| user_id | BIGINT | NOT NULL, INDEX | - | 归属用户ID，外键关联 user_info |
| name | VARCHAR(100) | NOT NULL | - | Agent 名称 |
| description | VARCHAR(500) | NULL | NULL | Agent 描述 |
| icon | VARCHAR(500) | NULL | NULL | Agent 图标URL |
| status | TINYINT | NOT NULL | 0 | 状态：0-草稿，1-已发布，2-下线 |
| graph_json | LONGTEXT | NULL | NULL | **核心字段**，草稿版DAG图结构JSON（含nodes, edges, schemaPolicy） |
| published_version_id | BIGINT | NULL | NULL | 当前线上使用的版本ID，关联 agent_version |
| deleted | TINYINT | NOT NULL | 0 | 逻辑删除：0-正常，1-已删除 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

---

### 3. `agent_version` (Agent 版本发布表)

**作用**：存储**已发布**的 Agent 快照。一旦发布，版本不可修改，确保线上流量不受草稿编辑影响。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 版本ID，主键 |
| agent_id | BIGINT | NOT NULL, INDEX | - | 关联Agent ID |
| version | INT | NOT NULL | - | 版本号（1, 2, 3...），同一Agent下递增 |
| graph_snapshot | LONGTEXT | NOT NULL | - | **核心字段**，发布时的 graph_json 完整副本（不可变） |
| description | VARCHAR(500) | NULL | NULL | 版本发布说明 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 发布时间 |

**唯一约束**：`UNIQUE (agent_id, version)` — 同一Agent下版本号唯一

---

### 4. `node_template` (节点模版/类型表)

**作用**：定义系统支持哪些节点类型（如：LLM节点、知识库检索、意图识别等）。同时定义该节点的**结构策略**（能否删减输入输出）。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 节点模版ID，主键 |
| type_code | VARCHAR(50) | UNIQUE, NOT NULL | - | 类型编码（如 "LLM", "MCP_TOOL", "RAG", "HUMAN"） |
| name | VARCHAR(100) | NOT NULL | - | 显示名称（如 "大模型节点"） |
| description | VARCHAR(500) | NULL | NULL | 节点类型描述 |
| icon | VARCHAR(200) | NULL | NULL | 节点图标 |
| default_schema_policy | JSON | NULL | NULL | **核心字段**，定义是否允许用户新增/删除 Input 或 Output 结构 |
| initial_schema | JSON | NULL | NULL | 节点初始化时默认的输入输出参数（含 isSystem=true 的字段） |
| category | VARCHAR(50) | NULL | NULL | 节点分类（如 "基础节点"、"AI节点"、"工具节点"） |
| sort_order | INT | NOT NULL | 0 | 排序权重 |
| status | TINYINT | NOT NULL | 1 | 状态：0-禁用，1-启用 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

---

### 5. `sys_config_field_def` (配置字段字典表)

**作用**：定义所有可用的原子配置项。对应前端节点配置弹窗中的各个表单控件。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 字段定义ID，主键 |
| field_key | VARCHAR(100) | UNIQUE, NOT NULL | - | 字段键名（如 "temperature", "model_name"） |
| field_label | VARCHAR(100) | NOT NULL | - | 前端显示标签（如 "温度"） |
| field_type | VARCHAR(50) | NOT NULL | - | 控件类型：text, textarea, select, boolean, number, json, slider |
| options | JSON | NULL | NULL | 下拉选项数据，格式：[{"label":"选项1","value":"v1"}] |
| default_value | VARCHAR(500) | NULL | NULL | 全局默认值 |
| placeholder | VARCHAR(200) | NULL | NULL | 输入提示文本 |
| description | VARCHAR(500) | NULL | NULL | 字段说明/帮助文本 |
| validation_rules | JSON | NULL | NULL | 校验规则（如 {"min":0,"max":1,"required":true}） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

---

### 6. `node_template_config_mapping` (节点与配置关联表)

**作用**：**关联表**，定义某个节点类型由哪些配置字段组成。例如 "LLM 节点" 包含 temperature、model_name 等字段。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 映射ID，主键 |
| node_template_id | BIGINT | NOT NULL, INDEX | - | 关联节点模版ID |
| field_def_id | BIGINT | NOT NULL, INDEX | - | 关联配置字段ID |
| group_name | VARCHAR(50) | NULL | '基础配置' | 分组名称（如 "基础参数"、"高级设置"） |
| sort_order | INT | NOT NULL | 0 | 在该节点表单中的排序 |
| override_default | VARCHAR(500) | NULL | NULL | 覆盖该节点特定的默认值 |
| is_required | TINYINT | NOT NULL | 0 | 是否必填 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |

**唯一约束**：`UNIQUE (node_template_id, field_def_id)` — 同一节点不重复关联同一字段

---

## 三、智能对话模块（会话管理）

### 7. `conversation` (会话表)

**作用**：存储用户与 Agent 之间的会话记录。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 会话ID，主键 |
| conversation_id | VARCHAR(50) | UNIQUE, NOT NULL | - | 会话业务ID（UUID格式） |
| user_id | BIGINT | NOT NULL, INDEX | - | 用户ID，外键关联 user_info |
| agent_id | BIGINT | NOT NULL, INDEX | - | Agent ID，外键关联 agent_info |
| title | VARCHAR(200) | NULL | NULL | 会话标题（可从首条消息自动生成） |
| message_count | INT | NOT NULL | 0 | 消息数量统计 |
| last_message_time | DATETIME | NULL | NULL | 最后消息时间 |
| deleted | TINYINT | NOT NULL | 0 | 逻辑删除：0-正常，1-已删除 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 创建时间 |
| updated_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 更新时间 |

**联合索引**：`INDEX idx_user_agent (user_id, agent_id)` — 支持查询用户与某Agent的会话

---

## 四、工作流执行模块（运行时）

> 基于**高性能读写分离（列表页 0 Join）** 策略设计。核心思想：在主表中冗余存储"一问一答"的核心文本，使得查询聊天记录列表时极其快速；而"深度思考过程"和"调试详情"则存放在日志表中，按需异步加载。

---

### 8. `workflow_execution` (执行实例表)

**作用**：记录每一次对话任务的完整生命周期。**高性能优化**：直接存储用户提问和 Agent 最终回复，渲染"聊天主列表"时只需查这一张表。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 执行记录ID，主键 |
| execution_id | VARCHAR(50) | UNIQUE, NOT NULL | - | 执行业务ID（UUID格式） |
| conversation_id | VARCHAR(50) | NOT NULL, INDEX | - | 所属会话ID |
| agent_version_id | BIGINT | NOT NULL | - | 关联的 Agent 版本ID |
| status | VARCHAR(20) | NOT NULL | 'RUNNING' | 状态：RUNNING, SUCCEEDED, FAILED, PAUSED, CANCELLED |
| user_query | TEXT | NOT NULL | - | **[冗余/核心]** 用户发送的消息文本快照 |
| final_response | TEXT | NULL | NULL | **[冗余/核心]** Agent 执行结束后的最终回复 |
| token_usage | INT | NULL | NULL | 本次消耗的总 Token 数（计费用） |
| debug_mode | TINYINT | NOT NULL | 0 | 是否调试模式执行：0-否，1-是 |
| error_message | VARCHAR(1000) | NULL | NULL | 失败时的错误信息 |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 开始时间（用于排序） |
| finished_at | DATETIME | NULL | NULL | 结束时间（用于计算总耗时） |

**索引说明**：
- `INDEX idx_conversation (conversation_id)` — 支持按会话查询执行历史
- `INDEX idx_created (created_at)` — 支持时间排序

---

### 9. `workflow_node_execution_log` (节点流水日志表)

**作用**：存储 DAG 图中每个节点的执行细节。**按需加载**：当用户点击"查看思考过程"或开启"调试模式"时，才查询此表。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 日志ID，主键 |
| execution_id | VARCHAR(50) | NOT NULL, INDEX | - | 关联执行实例 |
| node_id | VARCHAR(100) | NOT NULL | - | 节点ID（如 step-1-search） |
| node_name | VARCHAR(100) | NOT NULL | - | 节点名称（如 "网络搜索"） |
| node_type | VARCHAR(50) | NOT NULL | - | 节点类型：LLM, TOOL, CODE, HUMAN, CONDITION |
| render_mode | VARCHAR(20) | NOT NULL | 'HIDDEN' | **[核心]** 可见性策略：HIDDEN-仅调试可见，THOUGHT-思考过程，MESSAGE-最终回复 |
| summary | VARCHAR(500) | NULL | NULL | **[核心]** 思考过程的简短摘要（折叠框标题） |
| content | LONGTEXT | NULL | NULL | 流式输出的完整文本内容 |
| inputs | JSON | NULL | NULL | **[调试]** 完整输入参数 JSON |
| outputs | JSON | NULL | NULL | **[调试]** 完整输出结果 JSON |
| status | TINYINT | NOT NULL | 0 | 执行状态：0-执行中，1-成功，2-失败 |
| error_message | VARCHAR(1000) | NULL | NULL | 失败时的错误信息 |
| duration_ms | INT | NULL | NULL | 节点执行耗时（毫秒） |
| token_usage | INT | NULL | NULL | 本节点消耗的 Token 数 |
| start_time | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 节点开始时间 |
| end_time | DATETIME | NULL | NULL | 节点结束时间 |

**索引说明**：
- `INDEX idx_execution (execution_id)` — 支持按执行实例查询所有节点日志
- `INDEX idx_execution_node (execution_id, node_id)` — 支持查询单节点详情

---

### 10. `execution_checkpoint` (断点恢复表)

**作用**：用于"暂停/继续"场景（如人工审批）或系统崩溃后的恢复。数据量相对较小，只存储必要的存档点。

#### 字段说明

| 字段名 | 类型 | 约束 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | BIGINT | PRIMARY KEY, AUTO_INCREMENT | - | 检查点ID，主键 |
| execution_id | VARCHAR(50) | NOT NULL, INDEX | - | 关联执行实例 |
| conversation_id | VARCHAR(50) | NOT NULL, INDEX | - | 关联会话ID（便于恢复查询） |
| node_id | VARCHAR(100) | NOT NULL | - | 存档时刚执行完的节点ID |
| global_context | JSON | NOT NULL | - | **[核心]** 整个工作流的变量池快照（包含之前所有节点的产出） |
| executed_nodes | JSON | NOT NULL | - | 已执行节点ID列表 JSON 数组 |
| paused_node_id | VARCHAR(100) | NULL | NULL | 如因人工审核暂停，记录暂停的节点ID |
| paused_reason | VARCHAR(500) | NULL | NULL | 暂停原因说明 |
| version | INT | NOT NULL | 1 | 检查点版本号（用于乐观锁） |
| created_at | DATETIME | NOT NULL | CURRENT_TIMESTAMP | 存档时间 |

**索引说明**：
- `INDEX idx_conversation (conversation_id)` — 支持按会话恢复执行

---

## 五、SQL 建表语句

```sql
-- ============================================================
-- 用户认证模块
-- ============================================================

CREATE TABLE IF NOT EXISTS `user_info` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '用户ID',
    `username` VARCHAR(50) NOT NULL COMMENT '用户名',
    `email` VARCHAR(100) NOT NULL COMMENT '邮箱地址（登录账号）',
    `password` VARCHAR(255) NOT NULL COMMENT 'BCrypt加密密码',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `avatar_url` VARCHAR(500) DEFAULT NULL COMMENT '头像URL',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-正常',
    `last_login_ip` VARCHAR(50) DEFAULT NULL COMMENT '最后登录IP',
    `last_login_time` DATETIME DEFAULT NULL COMMENT '最后登录时间',
    `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-正常，1-已删除',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户信息表';


-- ============================================================
-- Agent 管理模块
-- ============================================================

CREATE TABLE IF NOT EXISTS `agent_info` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT 'Agent ID',
    `user_id` BIGINT NOT NULL COMMENT '归属用户ID',
    `name` VARCHAR(100) NOT NULL COMMENT 'Agent名称',
    `description` VARCHAR(500) DEFAULT NULL COMMENT 'Agent描述',
    `icon` VARCHAR(500) DEFAULT NULL COMMENT 'Agent图标URL',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态：0-草稿，1-已发布，2-下线',
    `graph_json` LONGTEXT DEFAULT NULL COMMENT '草稿版DAG图结构JSON',
    `published_version_id` BIGINT DEFAULT NULL COMMENT '当前线上版本ID',
    `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-正常，1-已删除',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Agent信息主表';


CREATE TABLE IF NOT EXISTS `agent_version` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '版本ID',
    `agent_id` BIGINT NOT NULL COMMENT '关联Agent ID',
    `version` INT NOT NULL COMMENT '版本号',
    `graph_snapshot` LONGTEXT NOT NULL COMMENT '发布时的图结构快照（不可变）',
    `description` VARCHAR(500) DEFAULT NULL COMMENT '版本发布说明',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '发布时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_agent_version` (`agent_id`, `version`),
    KEY `idx_agent_id` (`agent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='Agent版本发布表';


CREATE TABLE IF NOT EXISTS `node_template` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '节点模版ID',
    `type_code` VARCHAR(50) NOT NULL COMMENT '类型编码（LLM, MCP_TOOL, RAG等）',
    `name` VARCHAR(100) NOT NULL COMMENT '显示名称',
    `description` VARCHAR(500) DEFAULT NULL COMMENT '节点类型描述',
    `icon` VARCHAR(200) DEFAULT NULL COMMENT '节点图标',
    `default_schema_policy` JSON DEFAULT NULL COMMENT '默认结构策略JSON',
    `initial_schema` JSON DEFAULT NULL COMMENT '初始输入输出参数JSON',
    `category` VARCHAR(50) DEFAULT NULL COMMENT '节点分类',
    `sort_order` INT NOT NULL DEFAULT 0 COMMENT '排序权重',
    `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：0-禁用，1-启用',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_type_code` (`type_code`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='节点模版/类型表';


CREATE TABLE IF NOT EXISTS `sys_config_field_def` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '字段定义ID',
    `field_key` VARCHAR(100) NOT NULL COMMENT '字段键名',
    `field_label` VARCHAR(100) NOT NULL COMMENT '前端显示标签',
    `field_type` VARCHAR(50) NOT NULL COMMENT '控件类型：text, textarea, select, boolean, number, json, slider',
    `options` JSON DEFAULT NULL COMMENT '下拉选项数据JSON',
    `default_value` VARCHAR(500) DEFAULT NULL COMMENT '全局默认值',
    `placeholder` VARCHAR(200) DEFAULT NULL COMMENT '输入提示文本',
    `description` VARCHAR(500) DEFAULT NULL COMMENT '字段说明',
    `validation_rules` JSON DEFAULT NULL COMMENT '校验规则JSON',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_field_key` (`field_key`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='配置字段字典表';


CREATE TABLE IF NOT EXISTS `node_template_config_mapping` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '映射ID',
    `node_template_id` BIGINT NOT NULL COMMENT '关联节点模版ID',
    `field_def_id` BIGINT NOT NULL COMMENT '关联配置字段ID',
    `group_name` VARCHAR(50) DEFAULT '基础配置' COMMENT '分组名称',
    `sort_order` INT NOT NULL DEFAULT 0 COMMENT '表单排序',
    `override_default` VARCHAR(500) DEFAULT NULL COMMENT '覆盖默认值',
    `is_required` TINYINT NOT NULL DEFAULT 0 COMMENT '是否必填',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_template_field` (`node_template_id`, `field_def_id`),
    KEY `idx_node_template_id` (`node_template_id`),
    KEY `idx_field_def_id` (`field_def_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='节点与配置关联表';


-- ============================================================
-- 智能对话模块
-- ============================================================

CREATE TABLE IF NOT EXISTS `conversation` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '会话ID',
    `conversation_id` VARCHAR(50) NOT NULL COMMENT '会话业务ID（UUID）',
    `user_id` BIGINT NOT NULL COMMENT '用户ID',
    `agent_id` BIGINT NOT NULL COMMENT 'Agent ID',
    `title` VARCHAR(200) DEFAULT NULL COMMENT '会话标题',
    `message_count` INT NOT NULL DEFAULT 0 COMMENT '消息数量',
    `last_message_time` DATETIME DEFAULT NULL COMMENT '最后消息时间',
    `deleted` TINYINT NOT NULL DEFAULT 0 COMMENT '逻辑删除：0-正常，1-已删除',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    `updated_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_conversation_id` (`conversation_id`),
    KEY `idx_user_agent` (`user_id`, `agent_id`),
    KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='会话表';


-- ============================================================
-- 工作流执行模块（运行时）
-- ============================================================

CREATE TABLE IF NOT EXISTS `workflow_execution` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '执行记录ID',
    `execution_id` VARCHAR(50) NOT NULL COMMENT '执行业务ID（UUID）',
    `conversation_id` VARCHAR(50) NOT NULL COMMENT '所属会话ID',
    `agent_version_id` BIGINT NOT NULL COMMENT '关联Agent版本ID',
    `status` VARCHAR(20) NOT NULL DEFAULT 'RUNNING' COMMENT '状态：RUNNING, SUCCEEDED, FAILED, PAUSED, CANCELLED',
    `user_query` TEXT NOT NULL COMMENT '用户消息快照（冗余字段）',
    `final_response` TEXT DEFAULT NULL COMMENT 'Agent最终回复（冗余字段）',
    `token_usage` INT DEFAULT NULL COMMENT '总Token消耗',
    `debug_mode` TINYINT NOT NULL DEFAULT 0 COMMENT '调试模式：0-否，1-是',
    `error_message` VARCHAR(1000) DEFAULT NULL COMMENT '错误信息',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '开始时间',
    `finished_at` DATETIME DEFAULT NULL COMMENT '结束时间',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_execution_id` (`execution_id`),
    KEY `idx_conversation_id` (`conversation_id`),
    KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='工作流执行实例表';


CREATE TABLE IF NOT EXISTS `workflow_node_execution_log` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '日志ID',
    `execution_id` VARCHAR(50) NOT NULL COMMENT '关联执行实例',
    `node_id` VARCHAR(100) NOT NULL COMMENT '节点ID',
    `node_name` VARCHAR(100) NOT NULL COMMENT '节点名称',
    `node_type` VARCHAR(50) NOT NULL COMMENT '节点类型',
    `render_mode` VARCHAR(20) NOT NULL DEFAULT 'HIDDEN' COMMENT '可见性：HIDDEN, THOUGHT, MESSAGE',
    `summary` VARCHAR(500) DEFAULT NULL COMMENT '思考过程摘要',
    `content` LONGTEXT DEFAULT NULL COMMENT '完整输出内容',
    `inputs` JSON DEFAULT NULL COMMENT '输入参数JSON（调试用）',
    `outputs` JSON DEFAULT NULL COMMENT '输出结果JSON（调试用）',
    `status` TINYINT NOT NULL DEFAULT 0 COMMENT '状态：0-执行中，1-成功，2-失败',
    `error_message` VARCHAR(1000) DEFAULT NULL COMMENT '错误信息',
    `duration_ms` INT DEFAULT NULL COMMENT '执行耗时（毫秒）',
    `token_usage` INT DEFAULT NULL COMMENT '节点Token消耗',
    `start_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '开始时间',
    `end_time` DATETIME DEFAULT NULL COMMENT '结束时间',
    PRIMARY KEY (`id`),
    KEY `idx_execution_id` (`execution_id`),
    KEY `idx_execution_node` (`execution_id`, `node_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='节点执行流水日志表';


CREATE TABLE IF NOT EXISTS `execution_checkpoint` (
    `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '检查点ID',
    `execution_id` VARCHAR(50) NOT NULL COMMENT '关联执行实例',
    `conversation_id` VARCHAR(50) NOT NULL COMMENT '关联会话ID',
    `node_id` VARCHAR(100) NOT NULL COMMENT '存档时刚执行完的节点ID',
    `global_context` JSON NOT NULL COMMENT '工作流变量池快照',
    `executed_nodes` JSON NOT NULL COMMENT '已执行节点ID列表',
    `paused_node_id` VARCHAR(100) DEFAULT NULL COMMENT '暂停节点ID',
    `paused_reason` VARCHAR(500) DEFAULT NULL COMMENT '暂停原因',
    `version` INT NOT NULL DEFAULT 1 COMMENT '检查点版本号',
    `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '存档时间',
    PRIMARY KEY (`id`),
    KEY `idx_execution_id` (`execution_id`),
    KEY `idx_conversation_id` (`conversation_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='执行断点恢复表';
```

---

## 六、高性能查询策略

### 1. 用户打开聊天窗口（默认视图）

```sql
SELECT execution_id, user_query, final_response, status, created_at 
FROM workflow_execution 
WHERE conversation_id = ? 
ORDER BY created_at ASC;
```

**性能**：极快，单表查询，无大字段传输。  
**展示**：显示一问一答，类似微信聊天。

### 2. 用户点击"深度思考"或"调试模式"

```sql
SELECT node_id, node_name, node_type, render_mode, summary, content, inputs, outputs, status, duration_ms
FROM workflow_node_execution_log 
WHERE execution_id = ?
ORDER BY start_time ASC;
```

**性能**：仅在用户主动交互时触发，不影响首屏加载速度。  
**展示**：展开折叠框，或显示侧边栏调试信息。

### 3. 恢复暂停的工作流

```sql
SELECT * FROM execution_checkpoint 
WHERE conversation_id = ? 
ORDER BY created_at DESC 
LIMIT 1;
```

**性能**：按会话 ID 快速定位最新检查点。  
**用途**：人工审核通过后恢复执行。

---

## 七、ER 关系图

```
┌─────────────────┐       ┌─────────────────┐       ┌─────────────────┐
│   user_info     │       │   agent_info    │       │  agent_version  │
├─────────────────┤       ├─────────────────┤       ├─────────────────┤
│ id (PK)         │◄──────│ user_id (FK)    │───────│ agent_id (FK)   │
│ username        │       │ id (PK)         │◄──────│ id (PK)         │
│ email           │       │ graph_json      │       │ graph_snapshot  │
│ password        │       │ published_      │       │ version         │
└─────────────────┘       │ version_id (FK) │       └─────────────────┘
                          └─────────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────────────┐
│  node_template  │       │sys_config_field │       │node_template_config_    │
│                 │       │     _def        │       │       mapping           │
├─────────────────┤       ├─────────────────┤       ├─────────────────────────┤
│ id (PK)         │◄──────│ id (PK)         │◄──────│ node_template_id (FK)   │
│ type_code       │       │ field_key       │       │ field_def_id (FK)       │
│ initial_schema  │       │ field_type      │       │ group_name              │
└─────────────────┘       └─────────────────┘       └─────────────────────────┘

┌─────────────────┐       ┌─────────────────┐       ┌─────────────────────────┐
│  conversation   │       │workflow_        │       │workflow_node_           │
│                 │       │  execution      │       │  execution_log          │
├─────────────────┤       ├─────────────────┤       ├─────────────────────────┤
│ conversation_id │◄──────│ conversation_id │───────│ execution_id (FK)       │
│ user_id (FK)    │       │ execution_id    │       │ node_id                 │
│ agent_id (FK)   │       │ user_query      │       │ render_mode             │
└─────────────────┘       │ final_response  │       └─────────────────────────┘
                          └─────────────────┘
                                  │
                                  ▼
                          ┌─────────────────┐
                          │ execution_      │
                          │   checkpoint    │
                          ├─────────────────┤
                          │ execution_id(FK)│
                          │ global_context  │
                          └─────────────────┘
```

---

## 八、版本历史

| 版本 | 日期 | 说明 |
|------|------|------|
| v1.0 | 2026-01-11 | 初版，包含完整的库表设计和SQL |