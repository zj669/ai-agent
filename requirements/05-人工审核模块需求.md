# AI-Agent 人工审核模块需求文档

## 1. 模块概述

### 1.1 模块名称
人工审核模块（Human Intervention）

### 1.2 模块定位
工作流编排模块的子功能 - 支持关键节点的人工介入

### 1.3 核心价值
- 在敏感操作前增加人工审核环节
- 支持审批通过后继续执行工作流
- 支持审批拒绝后终止或修改执行

---

## 2. 功能需求

### 2.1 暂停等待审核

**功能描述**：当工作流执行到人工介入节点时，自动暂停执行并等待人工审核。

**业务规则**：
- 推送暂停事件到前端（SSE paused 状态）
- 保存当前执行上下文快照
- 记录暂停节点信息
- 支持超时自动处理（可配置）

**触发条件**：
- 节点类型为 HUMAN
- 执行到该节点时自动触发

**SSE 事件**：
```
event: node_lifecycle
data: {"nodeId":"human-1","nodeName":"人工审核","status":"paused"}
```

---

### 2.2 审批通过

**功能描述**：审核人员批准后，恢复工作流继续执行。

**业务规则**：
- 从暂停点恢复执行
- 重新加载执行上下文
- 继续执行后续节点
- 推送恢复事件

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | String | 是 | 会话ID |
| nodeId | String | 是 | 暂停的节点ID |
| agentId | String | 是 | Agent ID |
| approved | Boolean | 是 | 是否批准（true） |

**输出**：SSE 事件流（恢复执行的后续事件）

**接口路径**：`POST /client/chat/review` (Content-Type: text/event-stream)

---

### 2.3 审批拒绝

**功能描述**：审核人员拒绝后，终止工作流执行。

**业务规则**：
- 标记工作流执行状态为失败/终止
- 推送拒绝事件
- 保存最终状态

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| conversationId | String | 是 | 会话ID |
| nodeId | String | 是 | 暂停的节点ID |
| approved | Boolean | 是 | 是否批准（false） |
| message | String | 否 | 拒绝原因 |

**输出**：
```json
{
  "success": true,
  "data": {
    "status": "rejected",
    "message": "审核已拒绝"
  }
}
```

**接口路径**：`POST /client/chat/review`

---

### 2.4 查询待审核状态

**功能描述**：查询当前会话是否处于等待人工审核状态。

**业务规则**：
- 检查会话的最新执行快照
- 判断是否有 PAUSED 状态的节点
- 返回暂停节点信息和可编辑字段

**输入参数**：
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| agentId | String | 是 | Agent ID |
| conversationId | String | 是 | 会话ID |

**输出**：
```json
{
  "isPaused": true,
  "humanIntervention": {
    "pausedNodeId": "human-1",
    "pausedNodeName": "内容审核",
    "reason": "等待审批",
    "canApprove": true,
    "canReject": true
  },
  "executionHistory": [...],
  "editableFields": [...]
}
```

**接口路径**：`GET /client/chat/{agentId}/snapshot/{conversationId}`

---

## 3. 可编辑字段功能

### 3.1 功能描述
在人工审核阶段，允许审核人员修改工作流执行上下文中的某些字段值。

### 3.2 字段元数据

```json
{
  "key": "analysis_result",
  "label": "分析结果",
  "type": "textarea",
  "currentValue": "当前值...",
  "description": "AI 生成的分析结果，可在此修改"
}
```

### 3.3 更新字段值

**接口路径**：`PUT /client/chat/{agentId}/snapshot/{conversationId}`

**输入参数**：
```json
{
  "nodeId": "human-1",
  "stateData": {
    "analysis_result": "修改后的分析结果"
  }
}
```

**业务规则**：
- 仅允许在 PAUSED 状态修改
- 修改后更新检查点
- 恢复执行时使用修改后的值

---

## 4. 人工介入节点配置

### 4.1 节点配置结构

```json
{
  "id": "human-1",
  "type": "HUMAN",
  "name": "内容审核",
  "config": {
    "title": "请审核以下生成内容",
    "description": "确认内容无误后点击批准继续执行",
    "timeout": 3600,
    "timeoutAction": "REJECT",
    "editableFields": ["content", "summary"],
    "reviewerRoles": ["admin", "reviewer"]
  }
}
```

### 4.2 配置项说明

| 配置项 | 类型 | 说明 |
|--------|------|------|
| title | String | 审核标题 |
| description | String | 审核说明 |
| timeout | Integer | 超时时间（秒） |
| timeoutAction | Enum | 超时处理：REJECT/APPROVE/SKIP |
| editableFields | Array | 允许编辑的字段名列表 |
| reviewerRoles | Array | 有权审核的角色列表 |

---

## 5. 非功能需求

### 5.1 安全性
- 审核操作需验证用户权限
- 审核日志完整记录

### 5.2 可用性
- 支持超时自动处理
- 前端实时显示等待状态

### 5.3 可追溯性
- 记录审核人、审核时间、审核结果
- 支持审核历史查询

---

## 6. 领域模型

### 6.1 值对象：HumanInterventionConfig

```java
HumanInterventionConfig {
    title: String
    description: String
    timeout: Integer
    timeoutAction: TimeoutAction
    editableFields: List<String>
    reviewerRoles: List<String>
}
```

### 6.2 领域事件

| 事件 | 说明 |
|------|------|
| ExecutionPausedEvent | 工作流暂停，等待人工审核 |
| ReviewApprovedEvent | 审核通过 |
| ReviewRejectedEvent | 审核拒绝 |
| ExecutionResumedEvent | 工作流恢复执行 |

---

## 7. 依赖关系

### 7.1 对外提供
- 审核状态查询
- 审批操作接口

### 7.2 依赖外部
- 工作流编排模块：暂停/恢复能力
- 上下文管理模块：快照读写
- 用户认证模块：权限验证
